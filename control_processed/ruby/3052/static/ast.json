{
  "type": "program",
  "start": {
    "row": 0,
    "column": 0
  },
  "end": {
    "row": 55,
    "column": 7
  },
  "text": "def call(env)\n      info      = (env[ENV_INFO_KEY] ||= RequestDetails.new)\n      info.id ||= env[HTTP_X_REQUEST_ID] || env[ACTION_DISPATCH_REQUEST_ID] || SecureRandom.uuid\n\n      time_started_service = Time.now                      # The wall time the request started being processed by rack\n      ts_started_service   = fsecs                         # The monotonic time the request started being processed by rack\n      time_started_wait    = RT._read_x_request_start(env) # The time the request was initially received by the web server (if available)\n      effective_overtime   = (wait_overtime && RT._request_has_body?(env)) ? wait_overtime : 0 # additional wait timeout (if set and applicable)\n      seconds_service_left = nil\n\n      # if X-Request-Start is present and wait_timeout is set, expire requests older than wait_timeout (+wait_overtime when applicable)\n      if time_started_wait && wait_timeout\n        seconds_waited          = time_started_service - time_started_wait # how long it took between the web server first receiving the request and rack being able to handle it\n        seconds_waited          = 0 if seconds_waited < 0                  # make up for potential time drift between the routing server and the application server\n        final_wait_timeout      = wait_timeout + effective_overtime        # how long the request will be allowed to have waited\n        seconds_service_left    = final_wait_timeout - seconds_waited      # first calculation of service timeout (relevant if request doesn't get expired, may be overriden later)\n        info.wait, info.timeout = seconds_waited, final_wait_timeout       # updating the info properties; info.timeout will be the wait timeout at this point\n        if seconds_service_left <= 0 # expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"\n        end\n      end\n\n      # pass request through if service_timeout is false (i.e., don't time it out at all.)\n      return @app.call(env) unless service_timeout\n\n      # compute actual timeout to be used for this request; if service_past_wait is true, this is just service_timeout. If false (the default), and wait time was determined, we'll use the shortest value between seconds_service_left and service_timeout. See comment above at service_past_wait for justification.\n      info.timeout = service_timeout # nice and simple, when service_past_wait is true, not so much otherwise:\n      info.timeout = seconds_service_left if !service_past_wait && seconds_service_left && seconds_service_left > 0 && seconds_service_left < service_timeout\n\n      RT._set_state! env, :ready                            # we're good to go, but have done nothing yet\n\n      heartbeat_event = nil                                 # init var so it's in scope for following proc\n      register_state_change = ->(status = :active) {        # updates service time and state; will run every second\n        heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status\n      }\n      heartbeat_event = RT::Scheduler.run_every(1) { register_state_change.call :active }  # start updating every second while active; if log level is debug, this will log every sec\n\n      timeout = RT::Scheduler::Timeout.new do |app_thread|  # creates a timeout instance responsible for timing out the request. the given block runs if timed out\n        register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")\n      end\n\n      response = timeout.timeout(info.timeout) do           # perform request with timeout\n        begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end\n      end\n\n      response\n    end",
  "children": [
    {
      "type": "method",
      "start": {
        "row": 0,
        "column": 0
      },
      "end": {
        "row": 55,
        "column": 7
      },
      "text": "def call(env)\n      info      = (env[ENV_INFO_KEY] ||= RequestDetails.new)\n      info.id ||= env[HTTP_X_REQUEST_ID] || env[ACTION_DISPATCH_REQUEST_ID] || SecureRandom.uuid\n\n      time_started_service = Time.now                      # The wall time the request started being processed by rack\n      ts_started_service   = fsecs                         # The monotonic time the request started being processed by rack\n      time_started_wait    = RT._read_x_request_start(env) # The time the request was initially received by the web server (if available)\n      effective_overtime   = (wait_overtime && RT._request_has_body?(env)) ? wait_overtime : 0 # additional wait timeout (if set and applicable)\n      seconds_service_left = nil\n\n      # if X-Request-Start is present and wait_timeout is set, expire requests older than wait_timeout (+wait_overtime when applicable)\n      if time_started_wait && wait_timeout\n        seconds_waited          = time_started_service - time_started_wait # how long it took between the web server first receiving the request and rack being able to handle it\n        seconds_waited          = 0 if seconds_waited < 0                  # make up for potential time drift between the routing server and the application server\n        final_wait_timeout      = wait_timeout + effective_overtime        # how long the request will be allowed to have waited\n        seconds_service_left    = final_wait_timeout - seconds_waited      # first calculation of service timeout (relevant if request doesn't get expired, may be overriden later)\n        info.wait, info.timeout = seconds_waited, final_wait_timeout       # updating the info properties; info.timeout will be the wait timeout at this point\n        if seconds_service_left <= 0 # expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"\n        end\n      end\n\n      # pass request through if service_timeout is false (i.e., don't time it out at all.)\n      return @app.call(env) unless service_timeout\n\n      # compute actual timeout to be used for this request; if service_past_wait is true, this is just service_timeout. If false (the default), and wait time was determined, we'll use the shortest value between seconds_service_left and service_timeout. See comment above at service_past_wait for justification.\n      info.timeout = service_timeout # nice and simple, when service_past_wait is true, not so much otherwise:\n      info.timeout = seconds_service_left if !service_past_wait && seconds_service_left && seconds_service_left > 0 && seconds_service_left < service_timeout\n\n      RT._set_state! env, :ready                            # we're good to go, but have done nothing yet\n\n      heartbeat_event = nil                                 # init var so it's in scope for following proc\n      register_state_change = ->(status = :active) {        # updates service time and state; will run every second\n        heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status\n      }\n      heartbeat_event = RT::Scheduler.run_every(1) { register_state_change.call :active }  # start updating every second while active; if log level is debug, this will log every sec\n\n      timeout = RT::Scheduler::Timeout.new do |app_thread|  # creates a timeout instance responsible for timing out the request. the given block runs if timed out\n        register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")\n      end\n\n      response = timeout.timeout(info.timeout) do           # perform request with timeout\n        begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end\n      end\n\n      response\n    end",
      "children": [
        {
          "type": "def",
          "start": {
            "row": 0,
            "column": 0
          },
          "end": {
            "row": 0,
            "column": 3
          },
          "text": "def"
        },
        {
          "type": "identifier",
          "start": {
            "row": 0,
            "column": 4
          },
          "end": {
            "row": 0,
            "column": 8
          },
          "text": "call"
        },
        {
          "type": "method_parameters",
          "start": {
            "row": 0,
            "column": 8
          },
          "end": {
            "row": 0,
            "column": 13
          },
          "text": "(env)",
          "children": [
            {
              "type": "(",
              "start": {
                "row": 0,
                "column": 8
              },
              "end": {
                "row": 0,
                "column": 9
              },
              "text": "("
            },
            {
              "type": "identifier",
              "start": {
                "row": 0,
                "column": 9
              },
              "end": {
                "row": 0,
                "column": 12
              },
              "text": "env"
            },
            {
              "type": ")",
              "start": {
                "row": 0,
                "column": 12
              },
              "end": {
                "row": 0,
                "column": 13
              },
              "text": ")"
            }
          ]
        },
        {
          "type": "body_statement",
          "start": {
            "row": 1,
            "column": 6
          },
          "end": {
            "row": 54,
            "column": 14
          },
          "text": "info      = (env[ENV_INFO_KEY] ||= RequestDetails.new)\n      info.id ||= env[HTTP_X_REQUEST_ID] || env[ACTION_DISPATCH_REQUEST_ID] || SecureRandom.uuid\n\n      time_started_service = Time.now                      # The wall time the request started being processed by rack\n      ts_started_service   = fsecs                         # The monotonic time the request started being processed by rack\n      time_started_wait    = RT._read_x_request_start(env) # The time the request was initially received by the web server (if available)\n      effective_overtime   = (wait_overtime && RT._request_has_body?(env)) ? wait_overtime : 0 # additional wait timeout (if set and applicable)\n      seconds_service_left = nil\n\n      # if X-Request-Start is present and wait_timeout is set, expire requests older than wait_timeout (+wait_overtime when applicable)\n      if time_started_wait && wait_timeout\n        seconds_waited          = time_started_service - time_started_wait # how long it took between the web server first receiving the request and rack being able to handle it\n        seconds_waited          = 0 if seconds_waited < 0                  # make up for potential time drift between the routing server and the application server\n        final_wait_timeout      = wait_timeout + effective_overtime        # how long the request will be allowed to have waited\n        seconds_service_left    = final_wait_timeout - seconds_waited      # first calculation of service timeout (relevant if request doesn't get expired, may be overriden later)\n        info.wait, info.timeout = seconds_waited, final_wait_timeout       # updating the info properties; info.timeout will be the wait timeout at this point\n        if seconds_service_left <= 0 # expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"\n        end\n      end\n\n      # pass request through if service_timeout is false (i.e., don't time it out at all.)\n      return @app.call(env) unless service_timeout\n\n      # compute actual timeout to be used for this request; if service_past_wait is true, this is just service_timeout. If false (the default), and wait time was determined, we'll use the shortest value between seconds_service_left and service_timeout. See comment above at service_past_wait for justification.\n      info.timeout = service_timeout # nice and simple, when service_past_wait is true, not so much otherwise:\n      info.timeout = seconds_service_left if !service_past_wait && seconds_service_left && seconds_service_left > 0 && seconds_service_left < service_timeout\n\n      RT._set_state! env, :ready                            # we're good to go, but have done nothing yet\n\n      heartbeat_event = nil                                 # init var so it's in scope for following proc\n      register_state_change = ->(status = :active) {        # updates service time and state; will run every second\n        heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status\n      }\n      heartbeat_event = RT::Scheduler.run_every(1) { register_state_change.call :active }  # start updating every second while active; if log level is debug, this will log every sec\n\n      timeout = RT::Scheduler::Timeout.new do |app_thread|  # creates a timeout instance responsible for timing out the request. the given block runs if timed out\n        register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")\n      end\n\n      response = timeout.timeout(info.timeout) do           # perform request with timeout\n        begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end\n      end\n\n      response",
          "children": [
            {
              "type": "assignment",
              "start": {
                "row": 1,
                "column": 6
              },
              "end": {
                "row": 1,
                "column": 60
              },
              "text": "info      = (env[ENV_INFO_KEY] ||= RequestDetails.new)",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 1,
                    "column": 6
                  },
                  "end": {
                    "row": 1,
                    "column": 10
                  },
                  "text": "info"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 1,
                    "column": 16
                  },
                  "end": {
                    "row": 1,
                    "column": 17
                  },
                  "text": "="
                },
                {
                  "type": "parenthesized_statements",
                  "start": {
                    "row": 1,
                    "column": 18
                  },
                  "end": {
                    "row": 1,
                    "column": 60
                  },
                  "text": "(env[ENV_INFO_KEY] ||= RequestDetails.new)",
                  "children": [
                    {
                      "type": "(",
                      "start": {
                        "row": 1,
                        "column": 18
                      },
                      "end": {
                        "row": 1,
                        "column": 19
                      },
                      "text": "("
                    },
                    {
                      "type": "operator_assignment",
                      "start": {
                        "row": 1,
                        "column": 19
                      },
                      "end": {
                        "row": 1,
                        "column": 59
                      },
                      "text": "env[ENV_INFO_KEY] ||= RequestDetails.new",
                      "children": [
                        {
                          "type": "element_reference",
                          "start": {
                            "row": 1,
                            "column": 19
                          },
                          "end": {
                            "row": 1,
                            "column": 36
                          },
                          "text": "env[ENV_INFO_KEY]",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 1,
                                "column": 19
                              },
                              "end": {
                                "row": 1,
                                "column": 22
                              },
                              "text": "env"
                            },
                            {
                              "type": "[",
                              "start": {
                                "row": 1,
                                "column": 22
                              },
                              "end": {
                                "row": 1,
                                "column": 23
                              },
                              "text": "["
                            },
                            {
                              "type": "constant",
                              "start": {
                                "row": 1,
                                "column": 23
                              },
                              "end": {
                                "row": 1,
                                "column": 35
                              },
                              "text": "ENV_INFO_KEY"
                            },
                            {
                              "type": "]",
                              "start": {
                                "row": 1,
                                "column": 35
                              },
                              "end": {
                                "row": 1,
                                "column": 36
                              },
                              "text": "]"
                            }
                          ]
                        },
                        {
                          "type": "||=",
                          "start": {
                            "row": 1,
                            "column": 37
                          },
                          "end": {
                            "row": 1,
                            "column": 40
                          },
                          "text": "||="
                        },
                        {
                          "type": "call",
                          "start": {
                            "row": 1,
                            "column": 41
                          },
                          "end": {
                            "row": 1,
                            "column": 59
                          },
                          "text": "RequestDetails.new",
                          "children": [
                            {
                              "type": "constant",
                              "start": {
                                "row": 1,
                                "column": 41
                              },
                              "end": {
                                "row": 1,
                                "column": 55
                              },
                              "text": "RequestDetails"
                            },
                            {
                              "type": ".",
                              "start": {
                                "row": 1,
                                "column": 55
                              },
                              "end": {
                                "row": 1,
                                "column": 56
                              },
                              "text": "."
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 1,
                                "column": 56
                              },
                              "end": {
                                "row": 1,
                                "column": 59
                              },
                              "text": "new"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": ")",
                      "start": {
                        "row": 1,
                        "column": 59
                      },
                      "end": {
                        "row": 1,
                        "column": 60
                      },
                      "text": ")"
                    }
                  ]
                }
              ]
            },
            {
              "type": "operator_assignment",
              "start": {
                "row": 2,
                "column": 6
              },
              "end": {
                "row": 2,
                "column": 96
              },
              "text": "info.id ||= env[HTTP_X_REQUEST_ID] || env[ACTION_DISPATCH_REQUEST_ID] || SecureRandom.uuid",
              "children": [
                {
                  "type": "call",
                  "start": {
                    "row": 2,
                    "column": 6
                  },
                  "end": {
                    "row": 2,
                    "column": 13
                  },
                  "text": "info.id",
                  "children": [
                    {
                      "type": "identifier",
                      "start": {
                        "row": 2,
                        "column": 6
                      },
                      "end": {
                        "row": 2,
                        "column": 10
                      },
                      "text": "info"
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 2,
                        "column": 10
                      },
                      "end": {
                        "row": 2,
                        "column": 11
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 2,
                        "column": 11
                      },
                      "end": {
                        "row": 2,
                        "column": 13
                      },
                      "text": "id"
                    }
                  ]
                },
                {
                  "type": "||=",
                  "start": {
                    "row": 2,
                    "column": 14
                  },
                  "end": {
                    "row": 2,
                    "column": 17
                  },
                  "text": "||="
                },
                {
                  "type": "binary",
                  "start": {
                    "row": 2,
                    "column": 18
                  },
                  "end": {
                    "row": 2,
                    "column": 96
                  },
                  "text": "env[HTTP_X_REQUEST_ID] || env[ACTION_DISPATCH_REQUEST_ID] || SecureRandom.uuid",
                  "children": [
                    {
                      "type": "binary",
                      "start": {
                        "row": 2,
                        "column": 18
                      },
                      "end": {
                        "row": 2,
                        "column": 75
                      },
                      "text": "env[HTTP_X_REQUEST_ID] || env[ACTION_DISPATCH_REQUEST_ID]",
                      "children": [
                        {
                          "type": "element_reference",
                          "start": {
                            "row": 2,
                            "column": 18
                          },
                          "end": {
                            "row": 2,
                            "column": 40
                          },
                          "text": "env[HTTP_X_REQUEST_ID]",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 2,
                                "column": 18
                              },
                              "end": {
                                "row": 2,
                                "column": 21
                              },
                              "text": "env"
                            },
                            {
                              "type": "[",
                              "start": {
                                "row": 2,
                                "column": 21
                              },
                              "end": {
                                "row": 2,
                                "column": 22
                              },
                              "text": "["
                            },
                            {
                              "type": "constant",
                              "start": {
                                "row": 2,
                                "column": 22
                              },
                              "end": {
                                "row": 2,
                                "column": 39
                              },
                              "text": "HTTP_X_REQUEST_ID"
                            },
                            {
                              "type": "]",
                              "start": {
                                "row": 2,
                                "column": 39
                              },
                              "end": {
                                "row": 2,
                                "column": 40
                              },
                              "text": "]"
                            }
                          ]
                        },
                        {
                          "type": "||",
                          "start": {
                            "row": 2,
                            "column": 41
                          },
                          "end": {
                            "row": 2,
                            "column": 43
                          },
                          "text": "||"
                        },
                        {
                          "type": "element_reference",
                          "start": {
                            "row": 2,
                            "column": 44
                          },
                          "end": {
                            "row": 2,
                            "column": 75
                          },
                          "text": "env[ACTION_DISPATCH_REQUEST_ID]",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 2,
                                "column": 44
                              },
                              "end": {
                                "row": 2,
                                "column": 47
                              },
                              "text": "env"
                            },
                            {
                              "type": "[",
                              "start": {
                                "row": 2,
                                "column": 47
                              },
                              "end": {
                                "row": 2,
                                "column": 48
                              },
                              "text": "["
                            },
                            {
                              "type": "constant",
                              "start": {
                                "row": 2,
                                "column": 48
                              },
                              "end": {
                                "row": 2,
                                "column": 74
                              },
                              "text": "ACTION_DISPATCH_REQUEST_ID"
                            },
                            {
                              "type": "]",
                              "start": {
                                "row": 2,
                                "column": 74
                              },
                              "end": {
                                "row": 2,
                                "column": 75
                              },
                              "text": "]"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "||",
                      "start": {
                        "row": 2,
                        "column": 76
                      },
                      "end": {
                        "row": 2,
                        "column": 78
                      },
                      "text": "||"
                    },
                    {
                      "type": "call",
                      "start": {
                        "row": 2,
                        "column": 79
                      },
                      "end": {
                        "row": 2,
                        "column": 96
                      },
                      "text": "SecureRandom.uuid",
                      "children": [
                        {
                          "type": "constant",
                          "start": {
                            "row": 2,
                            "column": 79
                          },
                          "end": {
                            "row": 2,
                            "column": 91
                          },
                          "text": "SecureRandom"
                        },
                        {
                          "type": ".",
                          "start": {
                            "row": 2,
                            "column": 91
                          },
                          "end": {
                            "row": 2,
                            "column": 92
                          },
                          "text": "."
                        },
                        {
                          "type": "identifier",
                          "start": {
                            "row": 2,
                            "column": 92
                          },
                          "end": {
                            "row": 2,
                            "column": 96
                          },
                          "text": "uuid"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "assignment",
              "start": {
                "row": 4,
                "column": 6
              },
              "end": {
                "row": 4,
                "column": 37
              },
              "text": "time_started_service = Time.now",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 4,
                    "column": 6
                  },
                  "end": {
                    "row": 4,
                    "column": 26
                  },
                  "text": "time_started_service"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 4,
                    "column": 27
                  },
                  "end": {
                    "row": 4,
                    "column": 28
                  },
                  "text": "="
                },
                {
                  "type": "call",
                  "start": {
                    "row": 4,
                    "column": 29
                  },
                  "end": {
                    "row": 4,
                    "column": 37
                  },
                  "text": "Time.now",
                  "children": [
                    {
                      "type": "constant",
                      "start": {
                        "row": 4,
                        "column": 29
                      },
                      "end": {
                        "row": 4,
                        "column": 33
                      },
                      "text": "Time"
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 4,
                        "column": 33
                      },
                      "end": {
                        "row": 4,
                        "column": 34
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 4,
                        "column": 34
                      },
                      "end": {
                        "row": 4,
                        "column": 37
                      },
                      "text": "now"
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 4,
                "column": 59
              },
              "end": {
                "row": 4,
                "column": 118
              },
              "text": "# The wall time the request started being processed by rack"
            },
            {
              "type": "assignment",
              "start": {
                "row": 5,
                "column": 6
              },
              "end": {
                "row": 5,
                "column": 34
              },
              "text": "ts_started_service   = fsecs",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 5,
                    "column": 6
                  },
                  "end": {
                    "row": 5,
                    "column": 24
                  },
                  "text": "ts_started_service"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 5,
                    "column": 27
                  },
                  "end": {
                    "row": 5,
                    "column": 28
                  },
                  "text": "="
                },
                {
                  "type": "identifier",
                  "start": {
                    "row": 5,
                    "column": 29
                  },
                  "end": {
                    "row": 5,
                    "column": 34
                  },
                  "text": "fsecs"
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 5,
                "column": 59
              },
              "end": {
                "row": 5,
                "column": 123
              },
              "text": "# The monotonic time the request started being processed by rack"
            },
            {
              "type": "assignment",
              "start": {
                "row": 6,
                "column": 6
              },
              "end": {
                "row": 6,
                "column": 58
              },
              "text": "time_started_wait    = RT._read_x_request_start(env)",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 6,
                    "column": 6
                  },
                  "end": {
                    "row": 6,
                    "column": 23
                  },
                  "text": "time_started_wait"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 6,
                    "column": 27
                  },
                  "end": {
                    "row": 6,
                    "column": 28
                  },
                  "text": "="
                },
                {
                  "type": "call",
                  "start": {
                    "row": 6,
                    "column": 29
                  },
                  "end": {
                    "row": 6,
                    "column": 58
                  },
                  "text": "RT._read_x_request_start(env)",
                  "children": [
                    {
                      "type": "constant",
                      "start": {
                        "row": 6,
                        "column": 29
                      },
                      "end": {
                        "row": 6,
                        "column": 31
                      },
                      "text": "RT"
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 6,
                        "column": 31
                      },
                      "end": {
                        "row": 6,
                        "column": 32
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 6,
                        "column": 32
                      },
                      "end": {
                        "row": 6,
                        "column": 53
                      },
                      "text": "_read_x_request_start"
                    },
                    {
                      "type": "argument_list",
                      "start": {
                        "row": 6,
                        "column": 53
                      },
                      "end": {
                        "row": 6,
                        "column": 58
                      },
                      "text": "(env)",
                      "children": [
                        {
                          "type": "(",
                          "start": {
                            "row": 6,
                            "column": 53
                          },
                          "end": {
                            "row": 6,
                            "column": 54
                          },
                          "text": "("
                        },
                        {
                          "type": "identifier",
                          "start": {
                            "row": 6,
                            "column": 54
                          },
                          "end": {
                            "row": 6,
                            "column": 57
                          },
                          "text": "env"
                        },
                        {
                          "type": ")",
                          "start": {
                            "row": 6,
                            "column": 57
                          },
                          "end": {
                            "row": 6,
                            "column": 58
                          },
                          "text": ")"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 6,
                "column": 59
              },
              "end": {
                "row": 6,
                "column": 137
              },
              "text": "# The time the request was initially received by the web server (if available)"
            },
            {
              "type": "assignment",
              "start": {
                "row": 7,
                "column": 6
              },
              "end": {
                "row": 7,
                "column": 94
              },
              "text": "effective_overtime   = (wait_overtime && RT._request_has_body?(env)) ? wait_overtime : 0",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 7,
                    "column": 6
                  },
                  "end": {
                    "row": 7,
                    "column": 24
                  },
                  "text": "effective_overtime"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 7,
                    "column": 27
                  },
                  "end": {
                    "row": 7,
                    "column": 28
                  },
                  "text": "="
                },
                {
                  "type": "conditional",
                  "start": {
                    "row": 7,
                    "column": 29
                  },
                  "end": {
                    "row": 7,
                    "column": 94
                  },
                  "text": "(wait_overtime && RT._request_has_body?(env)) ? wait_overtime : 0",
                  "children": [
                    {
                      "type": "parenthesized_statements",
                      "start": {
                        "row": 7,
                        "column": 29
                      },
                      "end": {
                        "row": 7,
                        "column": 74
                      },
                      "text": "(wait_overtime && RT._request_has_body?(env))",
                      "children": [
                        {
                          "type": "(",
                          "start": {
                            "row": 7,
                            "column": 29
                          },
                          "end": {
                            "row": 7,
                            "column": 30
                          },
                          "text": "("
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 7,
                            "column": 30
                          },
                          "end": {
                            "row": 7,
                            "column": 73
                          },
                          "text": "wait_overtime && RT._request_has_body?(env)",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 7,
                                "column": 30
                              },
                              "end": {
                                "row": 7,
                                "column": 43
                              },
                              "text": "wait_overtime"
                            },
                            {
                              "type": "&&",
                              "start": {
                                "row": 7,
                                "column": 44
                              },
                              "end": {
                                "row": 7,
                                "column": 46
                              },
                              "text": "&&"
                            },
                            {
                              "type": "call",
                              "start": {
                                "row": 7,
                                "column": 47
                              },
                              "end": {
                                "row": 7,
                                "column": 73
                              },
                              "text": "RT._request_has_body?(env)",
                              "children": [
                                {
                                  "type": "constant",
                                  "start": {
                                    "row": 7,
                                    "column": 47
                                  },
                                  "end": {
                                    "row": 7,
                                    "column": 49
                                  },
                                  "text": "RT"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 7,
                                    "column": 49
                                  },
                                  "end": {
                                    "row": 7,
                                    "column": 50
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 7,
                                    "column": 50
                                  },
                                  "end": {
                                    "row": 7,
                                    "column": 68
                                  },
                                  "text": "_request_has_body?"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 7,
                                    "column": 68
                                  },
                                  "end": {
                                    "row": 7,
                                    "column": 73
                                  },
                                  "text": "(env)",
                                  "children": [
                                    {
                                      "type": "(",
                                      "start": {
                                        "row": 7,
                                        "column": 68
                                      },
                                      "end": {
                                        "row": 7,
                                        "column": 69
                                      },
                                      "text": "("
                                    },
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 7,
                                        "column": 69
                                      },
                                      "end": {
                                        "row": 7,
                                        "column": 72
                                      },
                                      "text": "env"
                                    },
                                    {
                                      "type": ")",
                                      "start": {
                                        "row": 7,
                                        "column": 72
                                      },
                                      "end": {
                                        "row": 7,
                                        "column": 73
                                      },
                                      "text": ")"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": ")",
                          "start": {
                            "row": 7,
                            "column": 73
                          },
                          "end": {
                            "row": 7,
                            "column": 74
                          },
                          "text": ")"
                        }
                      ]
                    },
                    {
                      "type": "?",
                      "start": {
                        "row": 7,
                        "column": 75
                      },
                      "end": {
                        "row": 7,
                        "column": 76
                      },
                      "text": "?"
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 7,
                        "column": 77
                      },
                      "end": {
                        "row": 7,
                        "column": 90
                      },
                      "text": "wait_overtime"
                    },
                    {
                      "type": ":",
                      "start": {
                        "row": 7,
                        "column": 91
                      },
                      "end": {
                        "row": 7,
                        "column": 92
                      },
                      "text": ":"
                    },
                    {
                      "type": "integer",
                      "start": {
                        "row": 7,
                        "column": 93
                      },
                      "end": {
                        "row": 7,
                        "column": 94
                      },
                      "text": "0"
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 7,
                "column": 95
              },
              "end": {
                "row": 7,
                "column": 144
              },
              "text": "# additional wait timeout (if set and applicable)"
            },
            {
              "type": "assignment",
              "start": {
                "row": 8,
                "column": 6
              },
              "end": {
                "row": 8,
                "column": 32
              },
              "text": "seconds_service_left = nil",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 8,
                    "column": 6
                  },
                  "end": {
                    "row": 8,
                    "column": 26
                  },
                  "text": "seconds_service_left"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 8,
                    "column": 27
                  },
                  "end": {
                    "row": 8,
                    "column": 28
                  },
                  "text": "="
                },
                {
                  "type": "nil",
                  "start": {
                    "row": 8,
                    "column": 29
                  },
                  "end": {
                    "row": 8,
                    "column": 32
                  },
                  "text": "nil",
                  "children": [
                    {
                      "type": "nil",
                      "start": {
                        "row": 8,
                        "column": 29
                      },
                      "end": {
                        "row": 8,
                        "column": 32
                      },
                      "text": "nil"
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 10,
                "column": 6
              },
              "end": {
                "row": 10,
                "column": 135
              },
              "text": "# if X-Request-Start is present and wait_timeout is set, expire requests older than wait_timeout (+wait_overtime when applicable)"
            },
            {
              "type": "if",
              "start": {
                "row": 11,
                "column": 6
              },
              "end": {
                "row": 21,
                "column": 9
              },
              "text": "if time_started_wait && wait_timeout\n        seconds_waited          = time_started_service - time_started_wait # how long it took between the web server first receiving the request and rack being able to handle it\n        seconds_waited          = 0 if seconds_waited < 0                  # make up for potential time drift between the routing server and the application server\n        final_wait_timeout      = wait_timeout + effective_overtime        # how long the request will be allowed to have waited\n        seconds_service_left    = final_wait_timeout - seconds_waited      # first calculation of service timeout (relevant if request doesn't get expired, may be overriden later)\n        info.wait, info.timeout = seconds_waited, final_wait_timeout       # updating the info properties; info.timeout will be the wait timeout at this point\n        if seconds_service_left <= 0 # expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"\n        end\n      end",
              "children": [
                {
                  "type": "if",
                  "start": {
                    "row": 11,
                    "column": 6
                  },
                  "end": {
                    "row": 11,
                    "column": 8
                  },
                  "text": "if"
                },
                {
                  "type": "binary",
                  "start": {
                    "row": 11,
                    "column": 9
                  },
                  "end": {
                    "row": 11,
                    "column": 42
                  },
                  "text": "time_started_wait && wait_timeout",
                  "children": [
                    {
                      "type": "identifier",
                      "start": {
                        "row": 11,
                        "column": 9
                      },
                      "end": {
                        "row": 11,
                        "column": 26
                      },
                      "text": "time_started_wait"
                    },
                    {
                      "type": "&&",
                      "start": {
                        "row": 11,
                        "column": 27
                      },
                      "end": {
                        "row": 11,
                        "column": 29
                      },
                      "text": "&&"
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 11,
                        "column": 30
                      },
                      "end": {
                        "row": 11,
                        "column": 42
                      },
                      "text": "wait_timeout"
                    }
                  ]
                },
                {
                  "type": "then",
                  "start": {
                    "row": 11,
                    "column": 42
                  },
                  "end": {
                    "row": 20,
                    "column": 11
                  },
                  "text": "\n        seconds_waited          = time_started_service - time_started_wait # how long it took between the web server first receiving the request and rack being able to handle it\n        seconds_waited          = 0 if seconds_waited < 0                  # make up for potential time drift between the routing server and the application server\n        final_wait_timeout      = wait_timeout + effective_overtime        # how long the request will be allowed to have waited\n        seconds_service_left    = final_wait_timeout - seconds_waited      # first calculation of service timeout (relevant if request doesn't get expired, may be overriden later)\n        info.wait, info.timeout = seconds_waited, final_wait_timeout       # updating the info properties; info.timeout will be the wait timeout at this point\n        if seconds_service_left <= 0 # expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"\n        end",
                  "children": [
                    {
                      "type": "assignment",
                      "start": {
                        "row": 12,
                        "column": 8
                      },
                      "end": {
                        "row": 12,
                        "column": 74
                      },
                      "text": "seconds_waited          = time_started_service - time_started_wait",
                      "children": [
                        {
                          "type": "identifier",
                          "start": {
                            "row": 12,
                            "column": 8
                          },
                          "end": {
                            "row": 12,
                            "column": 22
                          },
                          "text": "seconds_waited"
                        },
                        {
                          "type": "=",
                          "start": {
                            "row": 12,
                            "column": 32
                          },
                          "end": {
                            "row": 12,
                            "column": 33
                          },
                          "text": "="
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 12,
                            "column": 34
                          },
                          "end": {
                            "row": 12,
                            "column": 74
                          },
                          "text": "time_started_service - time_started_wait",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 12,
                                "column": 34
                              },
                              "end": {
                                "row": 12,
                                "column": 54
                              },
                              "text": "time_started_service"
                            },
                            {
                              "type": "-",
                              "start": {
                                "row": 12,
                                "column": 55
                              },
                              "end": {
                                "row": 12,
                                "column": 56
                              },
                              "text": "-"
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 12,
                                "column": 57
                              },
                              "end": {
                                "row": 12,
                                "column": 74
                              },
                              "text": "time_started_wait"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "comment",
                      "start": {
                        "row": 12,
                        "column": 75
                      },
                      "end": {
                        "row": 12,
                        "column": 177
                      },
                      "text": "# how long it took between the web server first receiving the request and rack being able to handle it"
                    },
                    {
                      "type": "if_modifier",
                      "start": {
                        "row": 13,
                        "column": 8
                      },
                      "end": {
                        "row": 13,
                        "column": 57
                      },
                      "text": "seconds_waited          = 0 if seconds_waited < 0",
                      "children": [
                        {
                          "type": "assignment",
                          "start": {
                            "row": 13,
                            "column": 8
                          },
                          "end": {
                            "row": 13,
                            "column": 35
                          },
                          "text": "seconds_waited          = 0",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 13,
                                "column": 8
                              },
                              "end": {
                                "row": 13,
                                "column": 22
                              },
                              "text": "seconds_waited"
                            },
                            {
                              "type": "=",
                              "start": {
                                "row": 13,
                                "column": 32
                              },
                              "end": {
                                "row": 13,
                                "column": 33
                              },
                              "text": "="
                            },
                            {
                              "type": "integer",
                              "start": {
                                "row": 13,
                                "column": 34
                              },
                              "end": {
                                "row": 13,
                                "column": 35
                              },
                              "text": "0"
                            }
                          ]
                        },
                        {
                          "type": "if",
                          "start": {
                            "row": 13,
                            "column": 36
                          },
                          "end": {
                            "row": 13,
                            "column": 38
                          },
                          "text": "if"
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 13,
                            "column": 39
                          },
                          "end": {
                            "row": 13,
                            "column": 57
                          },
                          "text": "seconds_waited < 0",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 13,
                                "column": 39
                              },
                              "end": {
                                "row": 13,
                                "column": 53
                              },
                              "text": "seconds_waited"
                            },
                            {
                              "type": "<",
                              "start": {
                                "row": 13,
                                "column": 54
                              },
                              "end": {
                                "row": 13,
                                "column": 55
                              },
                              "text": "<"
                            },
                            {
                              "type": "integer",
                              "start": {
                                "row": 13,
                                "column": 56
                              },
                              "end": {
                                "row": 13,
                                "column": 57
                              },
                              "text": "0"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "comment",
                      "start": {
                        "row": 13,
                        "column": 75
                      },
                      "end": {
                        "row": 13,
                        "column": 163
                      },
                      "text": "# make up for potential time drift between the routing server and the application server"
                    },
                    {
                      "type": "assignment",
                      "start": {
                        "row": 14,
                        "column": 8
                      },
                      "end": {
                        "row": 14,
                        "column": 67
                      },
                      "text": "final_wait_timeout      = wait_timeout + effective_overtime",
                      "children": [
                        {
                          "type": "identifier",
                          "start": {
                            "row": 14,
                            "column": 8
                          },
                          "end": {
                            "row": 14,
                            "column": 26
                          },
                          "text": "final_wait_timeout"
                        },
                        {
                          "type": "=",
                          "start": {
                            "row": 14,
                            "column": 32
                          },
                          "end": {
                            "row": 14,
                            "column": 33
                          },
                          "text": "="
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 14,
                            "column": 34
                          },
                          "end": {
                            "row": 14,
                            "column": 67
                          },
                          "text": "wait_timeout + effective_overtime",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 14,
                                "column": 34
                              },
                              "end": {
                                "row": 14,
                                "column": 46
                              },
                              "text": "wait_timeout"
                            },
                            {
                              "type": "+",
                              "start": {
                                "row": 14,
                                "column": 47
                              },
                              "end": {
                                "row": 14,
                                "column": 48
                              },
                              "text": "+"
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 14,
                                "column": 49
                              },
                              "end": {
                                "row": 14,
                                "column": 67
                              },
                              "text": "effective_overtime"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "comment",
                      "start": {
                        "row": 14,
                        "column": 75
                      },
                      "end": {
                        "row": 14,
                        "column": 128
                      },
                      "text": "# how long the request will be allowed to have waited"
                    },
                    {
                      "type": "assignment",
                      "start": {
                        "row": 15,
                        "column": 8
                      },
                      "end": {
                        "row": 15,
                        "column": 69
                      },
                      "text": "seconds_service_left    = final_wait_timeout - seconds_waited",
                      "children": [
                        {
                          "type": "identifier",
                          "start": {
                            "row": 15,
                            "column": 8
                          },
                          "end": {
                            "row": 15,
                            "column": 28
                          },
                          "text": "seconds_service_left"
                        },
                        {
                          "type": "=",
                          "start": {
                            "row": 15,
                            "column": 32
                          },
                          "end": {
                            "row": 15,
                            "column": 33
                          },
                          "text": "="
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 15,
                            "column": 34
                          },
                          "end": {
                            "row": 15,
                            "column": 69
                          },
                          "text": "final_wait_timeout - seconds_waited",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 15,
                                "column": 34
                              },
                              "end": {
                                "row": 15,
                                "column": 52
                              },
                              "text": "final_wait_timeout"
                            },
                            {
                              "type": "-",
                              "start": {
                                "row": 15,
                                "column": 53
                              },
                              "end": {
                                "row": 15,
                                "column": 54
                              },
                              "text": "-"
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 15,
                                "column": 55
                              },
                              "end": {
                                "row": 15,
                                "column": 69
                              },
                              "text": "seconds_waited"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "comment",
                      "start": {
                        "row": 15,
                        "column": 75
                      },
                      "end": {
                        "row": 15,
                        "column": 179
                      },
                      "text": "# first calculation of service timeout (relevant if request doesn't get expired, may be overriden later)"
                    },
                    {
                      "type": "assignment",
                      "start": {
                        "row": 16,
                        "column": 8
                      },
                      "end": {
                        "row": 16,
                        "column": 68
                      },
                      "text": "info.wait, info.timeout = seconds_waited, final_wait_timeout",
                      "children": [
                        {
                          "type": "left_assignment_list",
                          "start": {
                            "row": 16,
                            "column": 8
                          },
                          "end": {
                            "row": 16,
                            "column": 31
                          },
                          "text": "info.wait, info.timeout",
                          "children": [
                            {
                              "type": "call",
                              "start": {
                                "row": 16,
                                "column": 8
                              },
                              "end": {
                                "row": 16,
                                "column": 17
                              },
                              "text": "info.wait",
                              "children": [
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 16,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 16,
                                    "column": 12
                                  },
                                  "text": "info"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 16,
                                    "column": 12
                                  },
                                  "end": {
                                    "row": 16,
                                    "column": 13
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 16,
                                    "column": 13
                                  },
                                  "end": {
                                    "row": 16,
                                    "column": 17
                                  },
                                  "text": "wait"
                                }
                              ]
                            },
                            {
                              "type": ",",
                              "start": {
                                "row": 16,
                                "column": 17
                              },
                              "end": {
                                "row": 16,
                                "column": 18
                              },
                              "text": ","
                            },
                            {
                              "type": "call",
                              "start": {
                                "row": 16,
                                "column": 19
                              },
                              "end": {
                                "row": 16,
                                "column": 31
                              },
                              "text": "info.timeout",
                              "children": [
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 16,
                                    "column": 19
                                  },
                                  "end": {
                                    "row": 16,
                                    "column": 23
                                  },
                                  "text": "info"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 16,
                                    "column": 23
                                  },
                                  "end": {
                                    "row": 16,
                                    "column": 24
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 16,
                                    "column": 24
                                  },
                                  "end": {
                                    "row": 16,
                                    "column": 31
                                  },
                                  "text": "timeout"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "=",
                          "start": {
                            "row": 16,
                            "column": 32
                          },
                          "end": {
                            "row": 16,
                            "column": 33
                          },
                          "text": "="
                        },
                        {
                          "type": "right_assignment_list",
                          "start": {
                            "row": 16,
                            "column": 34
                          },
                          "end": {
                            "row": 16,
                            "column": 68
                          },
                          "text": "seconds_waited, final_wait_timeout",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 16,
                                "column": 34
                              },
                              "end": {
                                "row": 16,
                                "column": 48
                              },
                              "text": "seconds_waited"
                            },
                            {
                              "type": ",",
                              "start": {
                                "row": 16,
                                "column": 48
                              },
                              "end": {
                                "row": 16,
                                "column": 49
                              },
                              "text": ","
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 16,
                                "column": 50
                              },
                              "end": {
                                "row": 16,
                                "column": 68
                              },
                              "text": "final_wait_timeout"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "comment",
                      "start": {
                        "row": 16,
                        "column": 75
                      },
                      "end": {
                        "row": 16,
                        "column": 158
                      },
                      "text": "# updating the info properties; info.timeout will be the wait timeout at this point"
                    },
                    {
                      "type": "if",
                      "start": {
                        "row": 17,
                        "column": 8
                      },
                      "end": {
                        "row": 20,
                        "column": 11
                      },
                      "text": "if seconds_service_left <= 0 # expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"\n        end",
                      "children": [
                        {
                          "type": "if",
                          "start": {
                            "row": 17,
                            "column": 8
                          },
                          "end": {
                            "row": 17,
                            "column": 10
                          },
                          "text": "if"
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 17,
                            "column": 11
                          },
                          "end": {
                            "row": 17,
                            "column": 36
                          },
                          "text": "seconds_service_left <= 0",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 17,
                                "column": 11
                              },
                              "end": {
                                "row": 17,
                                "column": 31
                              },
                              "text": "seconds_service_left"
                            },
                            {
                              "type": "<=",
                              "start": {
                                "row": 17,
                                "column": 32
                              },
                              "end": {
                                "row": 17,
                                "column": 34
                              },
                              "text": "<="
                            },
                            {
                              "type": "integer",
                              "start": {
                                "row": 17,
                                "column": 35
                              },
                              "end": {
                                "row": 17,
                                "column": 36
                              },
                              "text": "0"
                            }
                          ]
                        },
                        {
                          "type": "comment",
                          "start": {
                            "row": 17,
                            "column": 37
                          },
                          "end": {
                            "row": 17,
                            "column": 188
                          },
                          "text": "# expire requests that have waited for too long in the queue (as they are assumed to have been dropped by the web server / routing layer at this point)"
                        },
                        {
                          "type": "then",
                          "start": {
                            "row": 17,
                            "column": 188
                          },
                          "end": {
                            "row": 19,
                            "column": 87
                          },
                          "text": "\n          RT._set_state! env, :expired\n          raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"",
                          "children": [
                            {
                              "type": "call",
                              "start": {
                                "row": 18,
                                "column": 10
                              },
                              "end": {
                                "row": 18,
                                "column": 38
                              },
                              "text": "RT._set_state! env, :expired",
                              "children": [
                                {
                                  "type": "constant",
                                  "start": {
                                    "row": 18,
                                    "column": 10
                                  },
                                  "end": {
                                    "row": 18,
                                    "column": 12
                                  },
                                  "text": "RT"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 18,
                                    "column": 12
                                  },
                                  "end": {
                                    "row": 18,
                                    "column": 13
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 18,
                                    "column": 13
                                  },
                                  "end": {
                                    "row": 18,
                                    "column": 24
                                  },
                                  "text": "_set_state!"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 18,
                                    "column": 25
                                  },
                                  "end": {
                                    "row": 18,
                                    "column": 38
                                  },
                                  "text": "env, :expired",
                                  "children": [
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 18,
                                        "column": 25
                                      },
                                      "end": {
                                        "row": 18,
                                        "column": 28
                                      },
                                      "text": "env"
                                    },
                                    {
                                      "type": ",",
                                      "start": {
                                        "row": 18,
                                        "column": 28
                                      },
                                      "end": {
                                        "row": 18,
                                        "column": 29
                                      },
                                      "text": ","
                                    },
                                    {
                                      "type": "simple_symbol",
                                      "start": {
                                        "row": 18,
                                        "column": 30
                                      },
                                      "end": {
                                        "row": 18,
                                        "column": 38
                                      },
                                      "text": ":expired"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "type": "call",
                              "start": {
                                "row": 19,
                                "column": 10
                              },
                              "end": {
                                "row": 19,
                                "column": 87
                              },
                              "text": "raise RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"",
                              "children": [
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 19,
                                    "column": 10
                                  },
                                  "end": {
                                    "row": 19,
                                    "column": 15
                                  },
                                  "text": "raise"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 19,
                                    "column": 16
                                  },
                                  "end": {
                                    "row": 19,
                                    "column": 87
                                  },
                                  "text": "RequestExpiryError.new(env), \"Request older than #{info.ms(:timeout)}.\"",
                                  "children": [
                                    {
                                      "type": "call",
                                      "start": {
                                        "row": 19,
                                        "column": 16
                                      },
                                      "end": {
                                        "row": 19,
                                        "column": 43
                                      },
                                      "text": "RequestExpiryError.new(env)",
                                      "children": [
                                        {
                                          "type": "constant",
                                          "start": {
                                            "row": 19,
                                            "column": 16
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 34
                                          },
                                          "text": "RequestExpiryError"
                                        },
                                        {
                                          "type": ".",
                                          "start": {
                                            "row": 19,
                                            "column": 34
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 35
                                          },
                                          "text": "."
                                        },
                                        {
                                          "type": "identifier",
                                          "start": {
                                            "row": 19,
                                            "column": 35
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 38
                                          },
                                          "text": "new"
                                        },
                                        {
                                          "type": "argument_list",
                                          "start": {
                                            "row": 19,
                                            "column": 38
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 43
                                          },
                                          "text": "(env)",
                                          "children": [
                                            {
                                              "type": "(",
                                              "start": {
                                                "row": 19,
                                                "column": 38
                                              },
                                              "end": {
                                                "row": 19,
                                                "column": 39
                                              },
                                              "text": "("
                                            },
                                            {
                                              "type": "identifier",
                                              "start": {
                                                "row": 19,
                                                "column": 39
                                              },
                                              "end": {
                                                "row": 19,
                                                "column": 42
                                              },
                                              "text": "env"
                                            },
                                            {
                                              "type": ")",
                                              "start": {
                                                "row": 19,
                                                "column": 42
                                              },
                                              "end": {
                                                "row": 19,
                                                "column": 43
                                              },
                                              "text": ")"
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "type": ",",
                                      "start": {
                                        "row": 19,
                                        "column": 43
                                      },
                                      "end": {
                                        "row": 19,
                                        "column": 44
                                      },
                                      "text": ","
                                    },
                                    {
                                      "type": "string",
                                      "start": {
                                        "row": 19,
                                        "column": 45
                                      },
                                      "end": {
                                        "row": 19,
                                        "column": 87
                                      },
                                      "text": "\"Request older than #{info.ms(:timeout)}.\"",
                                      "children": [
                                        {
                                          "type": "\"",
                                          "start": {
                                            "row": 19,
                                            "column": 45
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 46
                                          },
                                          "text": "\""
                                        },
                                        {
                                          "type": "string_content",
                                          "start": {
                                            "row": 19,
                                            "column": 46
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 65
                                          },
                                          "text": "Request older than "
                                        },
                                        {
                                          "type": "interpolation",
                                          "start": {
                                            "row": 19,
                                            "column": 65
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 85
                                          },
                                          "text": "#{info.ms(:timeout)}",
                                          "children": [
                                            {
                                              "type": "#{",
                                              "start": {
                                                "row": 19,
                                                "column": 65
                                              },
                                              "end": {
                                                "row": 19,
                                                "column": 67
                                              },
                                              "text": "#{"
                                            },
                                            {
                                              "type": "call",
                                              "start": {
                                                "row": 19,
                                                "column": 67
                                              },
                                              "end": {
                                                "row": 19,
                                                "column": 84
                                              },
                                              "text": "info.ms(:timeout)",
                                              "children": [
                                                {
                                                  "type": "identifier",
                                                  "start": {
                                                    "row": 19,
                                                    "column": 67
                                                  },
                                                  "end": {
                                                    "row": 19,
                                                    "column": 71
                                                  },
                                                  "text": "info"
                                                },
                                                {
                                                  "type": ".",
                                                  "start": {
                                                    "row": 19,
                                                    "column": 71
                                                  },
                                                  "end": {
                                                    "row": 19,
                                                    "column": 72
                                                  },
                                                  "text": "."
                                                },
                                                {
                                                  "type": "identifier",
                                                  "start": {
                                                    "row": 19,
                                                    "column": 72
                                                  },
                                                  "end": {
                                                    "row": 19,
                                                    "column": 74
                                                  },
                                                  "text": "ms"
                                                },
                                                {
                                                  "type": "argument_list",
                                                  "start": {
                                                    "row": 19,
                                                    "column": 74
                                                  },
                                                  "end": {
                                                    "row": 19,
                                                    "column": 84
                                                  },
                                                  "text": "(:timeout)",
                                                  "children": [
                                                    {
                                                      "type": "(",
                                                      "start": {
                                                        "row": 19,
                                                        "column": 74
                                                      },
                                                      "end": {
                                                        "row": 19,
                                                        "column": 75
                                                      },
                                                      "text": "("
                                                    },
                                                    {
                                                      "type": "simple_symbol",
                                                      "start": {
                                                        "row": 19,
                                                        "column": 75
                                                      },
                                                      "end": {
                                                        "row": 19,
                                                        "column": 83
                                                      },
                                                      "text": ":timeout"
                                                    },
                                                    {
                                                      "type": ")",
                                                      "start": {
                                                        "row": 19,
                                                        "column": 83
                                                      },
                                                      "end": {
                                                        "row": 19,
                                                        "column": 84
                                                      },
                                                      "text": ")"
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "type": "}",
                                              "start": {
                                                "row": 19,
                                                "column": 84
                                              },
                                              "end": {
                                                "row": 19,
                                                "column": 85
                                              },
                                              "text": "}"
                                            }
                                          ]
                                        },
                                        {
                                          "type": "string_content",
                                          "start": {
                                            "row": 19,
                                            "column": 85
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 86
                                          },
                                          "text": "."
                                        },
                                        {
                                          "type": "\"",
                                          "start": {
                                            "row": 19,
                                            "column": 86
                                          },
                                          "end": {
                                            "row": 19,
                                            "column": 87
                                          },
                                          "text": "\""
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "end",
                          "start": {
                            "row": 20,
                            "column": 8
                          },
                          "end": {
                            "row": 20,
                            "column": 11
                          },
                          "text": "end"
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "end",
                  "start": {
                    "row": 21,
                    "column": 6
                  },
                  "end": {
                    "row": 21,
                    "column": 9
                  },
                  "text": "end"
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 23,
                "column": 6
              },
              "end": {
                "row": 23,
                "column": 90
              },
              "text": "# pass request through if service_timeout is false (i.e., don't time it out at all.)"
            },
            {
              "type": "unless_modifier",
              "start": {
                "row": 24,
                "column": 6
              },
              "end": {
                "row": 24,
                "column": 50
              },
              "text": "return @app.call(env) unless service_timeout",
              "children": [
                {
                  "type": "return",
                  "start": {
                    "row": 24,
                    "column": 6
                  },
                  "end": {
                    "row": 24,
                    "column": 27
                  },
                  "text": "return @app.call(env)",
                  "children": [
                    {
                      "type": "return",
                      "start": {
                        "row": 24,
                        "column": 6
                      },
                      "end": {
                        "row": 24,
                        "column": 12
                      },
                      "text": "return"
                    },
                    {
                      "type": "argument_list",
                      "start": {
                        "row": 24,
                        "column": 13
                      },
                      "end": {
                        "row": 24,
                        "column": 27
                      },
                      "text": "@app.call(env)",
                      "children": [
                        {
                          "type": "call",
                          "start": {
                            "row": 24,
                            "column": 13
                          },
                          "end": {
                            "row": 24,
                            "column": 27
                          },
                          "text": "@app.call(env)",
                          "children": [
                            {
                              "type": "instance_variable",
                              "start": {
                                "row": 24,
                                "column": 13
                              },
                              "end": {
                                "row": 24,
                                "column": 17
                              },
                              "text": "@app"
                            },
                            {
                              "type": ".",
                              "start": {
                                "row": 24,
                                "column": 17
                              },
                              "end": {
                                "row": 24,
                                "column": 18
                              },
                              "text": "."
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 24,
                                "column": 18
                              },
                              "end": {
                                "row": 24,
                                "column": 22
                              },
                              "text": "call"
                            },
                            {
                              "type": "argument_list",
                              "start": {
                                "row": 24,
                                "column": 22
                              },
                              "end": {
                                "row": 24,
                                "column": 27
                              },
                              "text": "(env)",
                              "children": [
                                {
                                  "type": "(",
                                  "start": {
                                    "row": 24,
                                    "column": 22
                                  },
                                  "end": {
                                    "row": 24,
                                    "column": 23
                                  },
                                  "text": "("
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 24,
                                    "column": 23
                                  },
                                  "end": {
                                    "row": 24,
                                    "column": 26
                                  },
                                  "text": "env"
                                },
                                {
                                  "type": ")",
                                  "start": {
                                    "row": 24,
                                    "column": 26
                                  },
                                  "end": {
                                    "row": 24,
                                    "column": 27
                                  },
                                  "text": ")"
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "type": "unless",
                  "start": {
                    "row": 24,
                    "column": 28
                  },
                  "end": {
                    "row": 24,
                    "column": 34
                  },
                  "text": "unless"
                },
                {
                  "type": "identifier",
                  "start": {
                    "row": 24,
                    "column": 35
                  },
                  "end": {
                    "row": 24,
                    "column": 50
                  },
                  "text": "service_timeout"
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 26,
                "column": 6
              },
              "end": {
                "row": 26,
                "column": 310
              },
              "text": "# compute actual timeout to be used for this request; if service_past_wait is true, this is just service_timeout. If false (the default), and wait time was determined, we'll use the shortest value between seconds_service_left and service_timeout. See comment above at service_past_wait for justification."
            },
            {
              "type": "assignment",
              "start": {
                "row": 27,
                "column": 6
              },
              "end": {
                "row": 27,
                "column": 36
              },
              "text": "info.timeout = service_timeout",
              "children": [
                {
                  "type": "call",
                  "start": {
                    "row": 27,
                    "column": 6
                  },
                  "end": {
                    "row": 27,
                    "column": 18
                  },
                  "text": "info.timeout",
                  "children": [
                    {
                      "type": "identifier",
                      "start": {
                        "row": 27,
                        "column": 6
                      },
                      "end": {
                        "row": 27,
                        "column": 10
                      },
                      "text": "info"
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 27,
                        "column": 10
                      },
                      "end": {
                        "row": 27,
                        "column": 11
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 27,
                        "column": 11
                      },
                      "end": {
                        "row": 27,
                        "column": 18
                      },
                      "text": "timeout"
                    }
                  ]
                },
                {
                  "type": "=",
                  "start": {
                    "row": 27,
                    "column": 19
                  },
                  "end": {
                    "row": 27,
                    "column": 20
                  },
                  "text": "="
                },
                {
                  "type": "identifier",
                  "start": {
                    "row": 27,
                    "column": 21
                  },
                  "end": {
                    "row": 27,
                    "column": 36
                  },
                  "text": "service_timeout"
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 27,
                "column": 37
              },
              "end": {
                "row": 27,
                "column": 110
              },
              "text": "# nice and simple, when service_past_wait is true, not so much otherwise:"
            },
            {
              "type": "if_modifier",
              "start": {
                "row": 28,
                "column": 6
              },
              "end": {
                "row": 28,
                "column": 157
              },
              "text": "info.timeout = seconds_service_left if !service_past_wait && seconds_service_left && seconds_service_left > 0 && seconds_service_left < service_timeout",
              "children": [
                {
                  "type": "assignment",
                  "start": {
                    "row": 28,
                    "column": 6
                  },
                  "end": {
                    "row": 28,
                    "column": 41
                  },
                  "text": "info.timeout = seconds_service_left",
                  "children": [
                    {
                      "type": "call",
                      "start": {
                        "row": 28,
                        "column": 6
                      },
                      "end": {
                        "row": 28,
                        "column": 18
                      },
                      "text": "info.timeout",
                      "children": [
                        {
                          "type": "identifier",
                          "start": {
                            "row": 28,
                            "column": 6
                          },
                          "end": {
                            "row": 28,
                            "column": 10
                          },
                          "text": "info"
                        },
                        {
                          "type": ".",
                          "start": {
                            "row": 28,
                            "column": 10
                          },
                          "end": {
                            "row": 28,
                            "column": 11
                          },
                          "text": "."
                        },
                        {
                          "type": "identifier",
                          "start": {
                            "row": 28,
                            "column": 11
                          },
                          "end": {
                            "row": 28,
                            "column": 18
                          },
                          "text": "timeout"
                        }
                      ]
                    },
                    {
                      "type": "=",
                      "start": {
                        "row": 28,
                        "column": 19
                      },
                      "end": {
                        "row": 28,
                        "column": 20
                      },
                      "text": "="
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 28,
                        "column": 21
                      },
                      "end": {
                        "row": 28,
                        "column": 41
                      },
                      "text": "seconds_service_left"
                    }
                  ]
                },
                {
                  "type": "if",
                  "start": {
                    "row": 28,
                    "column": 42
                  },
                  "end": {
                    "row": 28,
                    "column": 44
                  },
                  "text": "if"
                },
                {
                  "type": "binary",
                  "start": {
                    "row": 28,
                    "column": 45
                  },
                  "end": {
                    "row": 28,
                    "column": 157
                  },
                  "text": "!service_past_wait && seconds_service_left && seconds_service_left > 0 && seconds_service_left < service_timeout",
                  "children": [
                    {
                      "type": "binary",
                      "start": {
                        "row": 28,
                        "column": 45
                      },
                      "end": {
                        "row": 28,
                        "column": 115
                      },
                      "text": "!service_past_wait && seconds_service_left && seconds_service_left > 0",
                      "children": [
                        {
                          "type": "binary",
                          "start": {
                            "row": 28,
                            "column": 45
                          },
                          "end": {
                            "row": 28,
                            "column": 87
                          },
                          "text": "!service_past_wait && seconds_service_left",
                          "children": [
                            {
                              "type": "unary",
                              "start": {
                                "row": 28,
                                "column": 45
                              },
                              "end": {
                                "row": 28,
                                "column": 63
                              },
                              "text": "!service_past_wait",
                              "children": [
                                {
                                  "type": "!",
                                  "start": {
                                    "row": 28,
                                    "column": 45
                                  },
                                  "end": {
                                    "row": 28,
                                    "column": 46
                                  },
                                  "text": "!"
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 28,
                                    "column": 46
                                  },
                                  "end": {
                                    "row": 28,
                                    "column": 63
                                  },
                                  "text": "service_past_wait"
                                }
                              ]
                            },
                            {
                              "type": "&&",
                              "start": {
                                "row": 28,
                                "column": 64
                              },
                              "end": {
                                "row": 28,
                                "column": 66
                              },
                              "text": "&&"
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 28,
                                "column": 67
                              },
                              "end": {
                                "row": 28,
                                "column": 87
                              },
                              "text": "seconds_service_left"
                            }
                          ]
                        },
                        {
                          "type": "&&",
                          "start": {
                            "row": 28,
                            "column": 88
                          },
                          "end": {
                            "row": 28,
                            "column": 90
                          },
                          "text": "&&"
                        },
                        {
                          "type": "binary",
                          "start": {
                            "row": 28,
                            "column": 91
                          },
                          "end": {
                            "row": 28,
                            "column": 115
                          },
                          "text": "seconds_service_left > 0",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 28,
                                "column": 91
                              },
                              "end": {
                                "row": 28,
                                "column": 111
                              },
                              "text": "seconds_service_left"
                            },
                            {
                              "type": ">",
                              "start": {
                                "row": 28,
                                "column": 112
                              },
                              "end": {
                                "row": 28,
                                "column": 113
                              },
                              "text": ">"
                            },
                            {
                              "type": "integer",
                              "start": {
                                "row": 28,
                                "column": 114
                              },
                              "end": {
                                "row": 28,
                                "column": 115
                              },
                              "text": "0"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      "type": "&&",
                      "start": {
                        "row": 28,
                        "column": 116
                      },
                      "end": {
                        "row": 28,
                        "column": 118
                      },
                      "text": "&&"
                    },
                    {
                      "type": "binary",
                      "start": {
                        "row": 28,
                        "column": 119
                      },
                      "end": {
                        "row": 28,
                        "column": 157
                      },
                      "text": "seconds_service_left < service_timeout",
                      "children": [
                        {
                          "type": "identifier",
                          "start": {
                            "row": 28,
                            "column": 119
                          },
                          "end": {
                            "row": 28,
                            "column": 139
                          },
                          "text": "seconds_service_left"
                        },
                        {
                          "type": "<",
                          "start": {
                            "row": 28,
                            "column": 140
                          },
                          "end": {
                            "row": 28,
                            "column": 141
                          },
                          "text": "<"
                        },
                        {
                          "type": "identifier",
                          "start": {
                            "row": 28,
                            "column": 142
                          },
                          "end": {
                            "row": 28,
                            "column": 157
                          },
                          "text": "service_timeout"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "call",
              "start": {
                "row": 30,
                "column": 6
              },
              "end": {
                "row": 30,
                "column": 32
              },
              "text": "RT._set_state! env, :ready",
              "children": [
                {
                  "type": "constant",
                  "start": {
                    "row": 30,
                    "column": 6
                  },
                  "end": {
                    "row": 30,
                    "column": 8
                  },
                  "text": "RT"
                },
                {
                  "type": ".",
                  "start": {
                    "row": 30,
                    "column": 8
                  },
                  "end": {
                    "row": 30,
                    "column": 9
                  },
                  "text": "."
                },
                {
                  "type": "identifier",
                  "start": {
                    "row": 30,
                    "column": 9
                  },
                  "end": {
                    "row": 30,
                    "column": 20
                  },
                  "text": "_set_state!"
                },
                {
                  "type": "argument_list",
                  "start": {
                    "row": 30,
                    "column": 21
                  },
                  "end": {
                    "row": 30,
                    "column": 32
                  },
                  "text": "env, :ready",
                  "children": [
                    {
                      "type": "identifier",
                      "start": {
                        "row": 30,
                        "column": 21
                      },
                      "end": {
                        "row": 30,
                        "column": 24
                      },
                      "text": "env"
                    },
                    {
                      "type": ",",
                      "start": {
                        "row": 30,
                        "column": 24
                      },
                      "end": {
                        "row": 30,
                        "column": 25
                      },
                      "text": ","
                    },
                    {
                      "type": "simple_symbol",
                      "start": {
                        "row": 30,
                        "column": 26
                      },
                      "end": {
                        "row": 30,
                        "column": 32
                      },
                      "text": ":ready"
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 30,
                "column": 60
              },
              "end": {
                "row": 30,
                "column": 105
              },
              "text": "# we're good to go, but have done nothing yet"
            },
            {
              "type": "assignment",
              "start": {
                "row": 32,
                "column": 6
              },
              "end": {
                "row": 32,
                "column": 27
              },
              "text": "heartbeat_event = nil",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 32,
                    "column": 6
                  },
                  "end": {
                    "row": 32,
                    "column": 21
                  },
                  "text": "heartbeat_event"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 32,
                    "column": 22
                  },
                  "end": {
                    "row": 32,
                    "column": 23
                  },
                  "text": "="
                },
                {
                  "type": "nil",
                  "start": {
                    "row": 32,
                    "column": 24
                  },
                  "end": {
                    "row": 32,
                    "column": 27
                  },
                  "text": "nil",
                  "children": [
                    {
                      "type": "nil",
                      "start": {
                        "row": 32,
                        "column": 24
                      },
                      "end": {
                        "row": 32,
                        "column": 27
                      },
                      "text": "nil"
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 32,
                "column": 60
              },
              "end": {
                "row": 32,
                "column": 106
              },
              "text": "# init var so it's in scope for following proc"
            },
            {
              "type": "assignment",
              "start": {
                "row": 33,
                "column": 6
              },
              "end": {
                "row": 37,
                "column": 7
              },
              "text": "register_state_change = ->(status = :active) {        # updates service time and state; will run every second\n        heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status\n      }",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 33,
                    "column": 6
                  },
                  "end": {
                    "row": 33,
                    "column": 27
                  },
                  "text": "register_state_change"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 33,
                    "column": 28
                  },
                  "end": {
                    "row": 33,
                    "column": 29
                  },
                  "text": "="
                },
                {
                  "type": "lambda",
                  "start": {
                    "row": 33,
                    "column": 30
                  },
                  "end": {
                    "row": 37,
                    "column": 7
                  },
                  "text": "->(status = :active) {        # updates service time and state; will run every second\n        heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status\n      }",
                  "children": [
                    {
                      "type": "->",
                      "start": {
                        "row": 33,
                        "column": 30
                      },
                      "end": {
                        "row": 33,
                        "column": 32
                      },
                      "text": "->"
                    },
                    {
                      "type": "lambda_parameters",
                      "start": {
                        "row": 33,
                        "column": 32
                      },
                      "end": {
                        "row": 33,
                        "column": 50
                      },
                      "text": "(status = :active)",
                      "children": [
                        {
                          "type": "(",
                          "start": {
                            "row": 33,
                            "column": 32
                          },
                          "end": {
                            "row": 33,
                            "column": 33
                          },
                          "text": "("
                        },
                        {
                          "type": "optional_parameter",
                          "start": {
                            "row": 33,
                            "column": 33
                          },
                          "end": {
                            "row": 33,
                            "column": 49
                          },
                          "text": "status = :active",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 33,
                                "column": 33
                              },
                              "end": {
                                "row": 33,
                                "column": 39
                              },
                              "text": "status"
                            },
                            {
                              "type": "=",
                              "start": {
                                "row": 33,
                                "column": 40
                              },
                              "end": {
                                "row": 33,
                                "column": 41
                              },
                              "text": "="
                            },
                            {
                              "type": "simple_symbol",
                              "start": {
                                "row": 33,
                                "column": 42
                              },
                              "end": {
                                "row": 33,
                                "column": 49
                              },
                              "text": ":active"
                            }
                          ]
                        },
                        {
                          "type": ")",
                          "start": {
                            "row": 33,
                            "column": 49
                          },
                          "end": {
                            "row": 33,
                            "column": 50
                          },
                          "text": ")"
                        }
                      ]
                    },
                    {
                      "type": "block",
                      "start": {
                        "row": 33,
                        "column": 51
                      },
                      "end": {
                        "row": 37,
                        "column": 7
                      },
                      "text": "{        # updates service time and state; will run every second\n        heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status\n      }",
                      "children": [
                        {
                          "type": "{",
                          "start": {
                            "row": 33,
                            "column": 51
                          },
                          "end": {
                            "row": 33,
                            "column": 52
                          },
                          "text": "{"
                        },
                        {
                          "type": "comment",
                          "start": {
                            "row": 33,
                            "column": 60
                          },
                          "end": {
                            "row": 33,
                            "column": 115
                          },
                          "text": "# updates service time and state; will run every second"
                        },
                        {
                          "type": "block_body",
                          "start": {
                            "row": 34,
                            "column": 8
                          },
                          "end": {
                            "row": 36,
                            "column": 75
                          },
                          "text": "heartbeat_event.cancel! if status != :active        # if the request is no longer active we should stop updating every second\n        info.service = fsecs - ts_started_service           # update service time\n        RT._set_state! env, status                          # update status",
                          "children": [
                            {
                              "type": "if_modifier",
                              "start": {
                                "row": 34,
                                "column": 8
                              },
                              "end": {
                                "row": 34,
                                "column": 52
                              },
                              "text": "heartbeat_event.cancel! if status != :active",
                              "children": [
                                {
                                  "type": "call",
                                  "start": {
                                    "row": 34,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 34,
                                    "column": 31
                                  },
                                  "text": "heartbeat_event.cancel!",
                                  "children": [
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 34,
                                        "column": 8
                                      },
                                      "end": {
                                        "row": 34,
                                        "column": 23
                                      },
                                      "text": "heartbeat_event"
                                    },
                                    {
                                      "type": ".",
                                      "start": {
                                        "row": 34,
                                        "column": 23
                                      },
                                      "end": {
                                        "row": 34,
                                        "column": 24
                                      },
                                      "text": "."
                                    },
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 34,
                                        "column": 24
                                      },
                                      "end": {
                                        "row": 34,
                                        "column": 31
                                      },
                                      "text": "cancel!"
                                    }
                                  ]
                                },
                                {
                                  "type": "if",
                                  "start": {
                                    "row": 34,
                                    "column": 32
                                  },
                                  "end": {
                                    "row": 34,
                                    "column": 34
                                  },
                                  "text": "if"
                                },
                                {
                                  "type": "binary",
                                  "start": {
                                    "row": 34,
                                    "column": 35
                                  },
                                  "end": {
                                    "row": 34,
                                    "column": 52
                                  },
                                  "text": "status != :active",
                                  "children": [
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 34,
                                        "column": 35
                                      },
                                      "end": {
                                        "row": 34,
                                        "column": 41
                                      },
                                      "text": "status"
                                    },
                                    {
                                      "type": "!=",
                                      "start": {
                                        "row": 34,
                                        "column": 42
                                      },
                                      "end": {
                                        "row": 34,
                                        "column": 44
                                      },
                                      "text": "!="
                                    },
                                    {
                                      "type": "simple_symbol",
                                      "start": {
                                        "row": 34,
                                        "column": 45
                                      },
                                      "end": {
                                        "row": 34,
                                        "column": 52
                                      },
                                      "text": ":active"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "type": "comment",
                              "start": {
                                "row": 34,
                                "column": 60
                              },
                              "end": {
                                "row": 34,
                                "column": 133
                              },
                              "text": "# if the request is no longer active we should stop updating every second"
                            },
                            {
                              "type": "assignment",
                              "start": {
                                "row": 35,
                                "column": 8
                              },
                              "end": {
                                "row": 35,
                                "column": 49
                              },
                              "text": "info.service = fsecs - ts_started_service",
                              "children": [
                                {
                                  "type": "call",
                                  "start": {
                                    "row": 35,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 35,
                                    "column": 20
                                  },
                                  "text": "info.service",
                                  "children": [
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 35,
                                        "column": 8
                                      },
                                      "end": {
                                        "row": 35,
                                        "column": 12
                                      },
                                      "text": "info"
                                    },
                                    {
                                      "type": ".",
                                      "start": {
                                        "row": 35,
                                        "column": 12
                                      },
                                      "end": {
                                        "row": 35,
                                        "column": 13
                                      },
                                      "text": "."
                                    },
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 35,
                                        "column": 13
                                      },
                                      "end": {
                                        "row": 35,
                                        "column": 20
                                      },
                                      "text": "service"
                                    }
                                  ]
                                },
                                {
                                  "type": "=",
                                  "start": {
                                    "row": 35,
                                    "column": 21
                                  },
                                  "end": {
                                    "row": 35,
                                    "column": 22
                                  },
                                  "text": "="
                                },
                                {
                                  "type": "binary",
                                  "start": {
                                    "row": 35,
                                    "column": 23
                                  },
                                  "end": {
                                    "row": 35,
                                    "column": 49
                                  },
                                  "text": "fsecs - ts_started_service",
                                  "children": [
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 35,
                                        "column": 23
                                      },
                                      "end": {
                                        "row": 35,
                                        "column": 28
                                      },
                                      "text": "fsecs"
                                    },
                                    {
                                      "type": "-",
                                      "start": {
                                        "row": 35,
                                        "column": 29
                                      },
                                      "end": {
                                        "row": 35,
                                        "column": 30
                                      },
                                      "text": "-"
                                    },
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 35,
                                        "column": 31
                                      },
                                      "end": {
                                        "row": 35,
                                        "column": 49
                                      },
                                      "text": "ts_started_service"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "type": "comment",
                              "start": {
                                "row": 35,
                                "column": 60
                              },
                              "end": {
                                "row": 35,
                                "column": 81
                              },
                              "text": "# update service time"
                            },
                            {
                              "type": "call",
                              "start": {
                                "row": 36,
                                "column": 8
                              },
                              "end": {
                                "row": 36,
                                "column": 34
                              },
                              "text": "RT._set_state! env, status",
                              "children": [
                                {
                                  "type": "constant",
                                  "start": {
                                    "row": 36,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 36,
                                    "column": 10
                                  },
                                  "text": "RT"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 36,
                                    "column": 10
                                  },
                                  "end": {
                                    "row": 36,
                                    "column": 11
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 36,
                                    "column": 11
                                  },
                                  "end": {
                                    "row": 36,
                                    "column": 22
                                  },
                                  "text": "_set_state!"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 36,
                                    "column": 23
                                  },
                                  "end": {
                                    "row": 36,
                                    "column": 34
                                  },
                                  "text": "env, status",
                                  "children": [
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 36,
                                        "column": 23
                                      },
                                      "end": {
                                        "row": 36,
                                        "column": 26
                                      },
                                      "text": "env"
                                    },
                                    {
                                      "type": ",",
                                      "start": {
                                        "row": 36,
                                        "column": 26
                                      },
                                      "end": {
                                        "row": 36,
                                        "column": 27
                                      },
                                      "text": ","
                                    },
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 36,
                                        "column": 28
                                      },
                                      "end": {
                                        "row": 36,
                                        "column": 34
                                      },
                                      "text": "status"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "type": "comment",
                              "start": {
                                "row": 36,
                                "column": 60
                              },
                              "end": {
                                "row": 36,
                                "column": 75
                              },
                              "text": "# update status"
                            }
                          ]
                        },
                        {
                          "type": "}",
                          "start": {
                            "row": 37,
                            "column": 6
                          },
                          "end": {
                            "row": 37,
                            "column": 7
                          },
                          "text": "}"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "assignment",
              "start": {
                "row": 38,
                "column": 6
              },
              "end": {
                "row": 38,
                "column": 89
              },
              "text": "heartbeat_event = RT::Scheduler.run_every(1) { register_state_change.call :active }",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 38,
                    "column": 6
                  },
                  "end": {
                    "row": 38,
                    "column": 21
                  },
                  "text": "heartbeat_event"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 38,
                    "column": 22
                  },
                  "end": {
                    "row": 38,
                    "column": 23
                  },
                  "text": "="
                },
                {
                  "type": "call",
                  "start": {
                    "row": 38,
                    "column": 24
                  },
                  "end": {
                    "row": 38,
                    "column": 89
                  },
                  "text": "RT::Scheduler.run_every(1) { register_state_change.call :active }",
                  "children": [
                    {
                      "type": "scope_resolution",
                      "start": {
                        "row": 38,
                        "column": 24
                      },
                      "end": {
                        "row": 38,
                        "column": 37
                      },
                      "text": "RT::Scheduler",
                      "children": [
                        {
                          "type": "constant",
                          "start": {
                            "row": 38,
                            "column": 24
                          },
                          "end": {
                            "row": 38,
                            "column": 26
                          },
                          "text": "RT"
                        },
                        {
                          "type": "::",
                          "start": {
                            "row": 38,
                            "column": 26
                          },
                          "end": {
                            "row": 38,
                            "column": 28
                          },
                          "text": "::"
                        },
                        {
                          "type": "constant",
                          "start": {
                            "row": 38,
                            "column": 28
                          },
                          "end": {
                            "row": 38,
                            "column": 37
                          },
                          "text": "Scheduler"
                        }
                      ]
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 38,
                        "column": 37
                      },
                      "end": {
                        "row": 38,
                        "column": 38
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 38,
                        "column": 38
                      },
                      "end": {
                        "row": 38,
                        "column": 47
                      },
                      "text": "run_every"
                    },
                    {
                      "type": "argument_list",
                      "start": {
                        "row": 38,
                        "column": 47
                      },
                      "end": {
                        "row": 38,
                        "column": 50
                      },
                      "text": "(1)",
                      "children": [
                        {
                          "type": "(",
                          "start": {
                            "row": 38,
                            "column": 47
                          },
                          "end": {
                            "row": 38,
                            "column": 48
                          },
                          "text": "("
                        },
                        {
                          "type": "integer",
                          "start": {
                            "row": 38,
                            "column": 48
                          },
                          "end": {
                            "row": 38,
                            "column": 49
                          },
                          "text": "1"
                        },
                        {
                          "type": ")",
                          "start": {
                            "row": 38,
                            "column": 49
                          },
                          "end": {
                            "row": 38,
                            "column": 50
                          },
                          "text": ")"
                        }
                      ]
                    },
                    {
                      "type": "block",
                      "start": {
                        "row": 38,
                        "column": 51
                      },
                      "end": {
                        "row": 38,
                        "column": 89
                      },
                      "text": "{ register_state_change.call :active }",
                      "children": [
                        {
                          "type": "{",
                          "start": {
                            "row": 38,
                            "column": 51
                          },
                          "end": {
                            "row": 38,
                            "column": 52
                          },
                          "text": "{"
                        },
                        {
                          "type": "block_body",
                          "start": {
                            "row": 38,
                            "column": 53
                          },
                          "end": {
                            "row": 38,
                            "column": 87
                          },
                          "text": "register_state_change.call :active",
                          "children": [
                            {
                              "type": "call",
                              "start": {
                                "row": 38,
                                "column": 53
                              },
                              "end": {
                                "row": 38,
                                "column": 87
                              },
                              "text": "register_state_change.call :active",
                              "children": [
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 38,
                                    "column": 53
                                  },
                                  "end": {
                                    "row": 38,
                                    "column": 74
                                  },
                                  "text": "register_state_change"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 38,
                                    "column": 74
                                  },
                                  "end": {
                                    "row": 38,
                                    "column": 75
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 38,
                                    "column": 75
                                  },
                                  "end": {
                                    "row": 38,
                                    "column": 79
                                  },
                                  "text": "call"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 38,
                                    "column": 80
                                  },
                                  "end": {
                                    "row": 38,
                                    "column": 87
                                  },
                                  "text": ":active",
                                  "children": [
                                    {
                                      "type": "simple_symbol",
                                      "start": {
                                        "row": 38,
                                        "column": 80
                                      },
                                      "end": {
                                        "row": 38,
                                        "column": 87
                                      },
                                      "text": ":active"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "}",
                          "start": {
                            "row": 38,
                            "column": 88
                          },
                          "end": {
                            "row": 38,
                            "column": 89
                          },
                          "text": "}"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "comment",
              "start": {
                "row": 38,
                "column": 91
              },
              "end": {
                "row": 38,
                "column": 181
              },
              "text": "# start updating every second while active; if log level is debug, this will log every sec"
            },
            {
              "type": "assignment",
              "start": {
                "row": 40,
                "column": 6
              },
              "end": {
                "row": 43,
                "column": 9
              },
              "text": "timeout = RT::Scheduler::Timeout.new do |app_thread|  # creates a timeout instance responsible for timing out the request. the given block runs if timed out\n        register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")\n      end",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 40,
                    "column": 6
                  },
                  "end": {
                    "row": 40,
                    "column": 13
                  },
                  "text": "timeout"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 40,
                    "column": 14
                  },
                  "end": {
                    "row": 40,
                    "column": 15
                  },
                  "text": "="
                },
                {
                  "type": "call",
                  "start": {
                    "row": 40,
                    "column": 16
                  },
                  "end": {
                    "row": 43,
                    "column": 9
                  },
                  "text": "RT::Scheduler::Timeout.new do |app_thread|  # creates a timeout instance responsible for timing out the request. the given block runs if timed out\n        register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")\n      end",
                  "children": [
                    {
                      "type": "scope_resolution",
                      "start": {
                        "row": 40,
                        "column": 16
                      },
                      "end": {
                        "row": 40,
                        "column": 38
                      },
                      "text": "RT::Scheduler::Timeout",
                      "children": [
                        {
                          "type": "scope_resolution",
                          "start": {
                            "row": 40,
                            "column": 16
                          },
                          "end": {
                            "row": 40,
                            "column": 29
                          },
                          "text": "RT::Scheduler",
                          "children": [
                            {
                              "type": "constant",
                              "start": {
                                "row": 40,
                                "column": 16
                              },
                              "end": {
                                "row": 40,
                                "column": 18
                              },
                              "text": "RT"
                            },
                            {
                              "type": "::",
                              "start": {
                                "row": 40,
                                "column": 18
                              },
                              "end": {
                                "row": 40,
                                "column": 20
                              },
                              "text": "::"
                            },
                            {
                              "type": "constant",
                              "start": {
                                "row": 40,
                                "column": 20
                              },
                              "end": {
                                "row": 40,
                                "column": 29
                              },
                              "text": "Scheduler"
                            }
                          ]
                        },
                        {
                          "type": "::",
                          "start": {
                            "row": 40,
                            "column": 29
                          },
                          "end": {
                            "row": 40,
                            "column": 31
                          },
                          "text": "::"
                        },
                        {
                          "type": "constant",
                          "start": {
                            "row": 40,
                            "column": 31
                          },
                          "end": {
                            "row": 40,
                            "column": 38
                          },
                          "text": "Timeout"
                        }
                      ]
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 40,
                        "column": 38
                      },
                      "end": {
                        "row": 40,
                        "column": 39
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 40,
                        "column": 39
                      },
                      "end": {
                        "row": 40,
                        "column": 42
                      },
                      "text": "new"
                    },
                    {
                      "type": "do_block",
                      "start": {
                        "row": 40,
                        "column": 43
                      },
                      "end": {
                        "row": 43,
                        "column": 9
                      },
                      "text": "do |app_thread|  # creates a timeout instance responsible for timing out the request. the given block runs if timed out\n        register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")\n      end",
                      "children": [
                        {
                          "type": "do",
                          "start": {
                            "row": 40,
                            "column": 43
                          },
                          "end": {
                            "row": 40,
                            "column": 45
                          },
                          "text": "do"
                        },
                        {
                          "type": "block_parameters",
                          "start": {
                            "row": 40,
                            "column": 46
                          },
                          "end": {
                            "row": 40,
                            "column": 58
                          },
                          "text": "|app_thread|",
                          "children": [
                            {
                              "type": "|",
                              "start": {
                                "row": 40,
                                "column": 46
                              },
                              "end": {
                                "row": 40,
                                "column": 47
                              },
                              "text": "|"
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 40,
                                "column": 47
                              },
                              "end": {
                                "row": 40,
                                "column": 57
                              },
                              "text": "app_thread"
                            },
                            {
                              "type": "|",
                              "start": {
                                "row": 40,
                                "column": 57
                              },
                              "end": {
                                "row": 40,
                                "column": 58
                              },
                              "text": "|"
                            }
                          ]
                        },
                        {
                          "type": "comment",
                          "start": {
                            "row": 40,
                            "column": 60
                          },
                          "end": {
                            "row": 40,
                            "column": 162
                          },
                          "text": "# creates a timeout instance responsible for timing out the request. the given block runs if timed out"
                        },
                        {
                          "type": "body_statement",
                          "start": {
                            "row": 41,
                            "column": 8
                          },
                          "end": {
                            "row": 42,
                            "column": 159
                          },
                          "text": "register_state_change.call :timed_out\n        app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")",
                          "children": [
                            {
                              "type": "call",
                              "start": {
                                "row": 41,
                                "column": 8
                              },
                              "end": {
                                "row": 41,
                                "column": 45
                              },
                              "text": "register_state_change.call :timed_out",
                              "children": [
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 41,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 41,
                                    "column": 29
                                  },
                                  "text": "register_state_change"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 41,
                                    "column": 29
                                  },
                                  "end": {
                                    "row": 41,
                                    "column": 30
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 41,
                                    "column": 30
                                  },
                                  "end": {
                                    "row": 41,
                                    "column": 34
                                  },
                                  "text": "call"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 41,
                                    "column": 35
                                  },
                                  "end": {
                                    "row": 41,
                                    "column": 45
                                  },
                                  "text": ":timed_out",
                                  "children": [
                                    {
                                      "type": "simple_symbol",
                                      "start": {
                                        "row": 41,
                                        "column": 35
                                      },
                                      "end": {
                                        "row": 41,
                                        "column": 45
                                      },
                                      "text": ":timed_out"
                                    }
                                  ]
                                }
                              ]
                            },
                            {
                              "type": "call",
                              "start": {
                                "row": 42,
                                "column": 8
                              },
                              "end": {
                                "row": 42,
                                "column": 159
                              },
                              "text": "app_thread.raise(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")",
                              "children": [
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 42,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 42,
                                    "column": 18
                                  },
                                  "text": "app_thread"
                                },
                                {
                                  "type": ".",
                                  "start": {
                                    "row": 42,
                                    "column": 18
                                  },
                                  "end": {
                                    "row": 42,
                                    "column": 19
                                  },
                                  "text": "."
                                },
                                {
                                  "type": "identifier",
                                  "start": {
                                    "row": 42,
                                    "column": 19
                                  },
                                  "end": {
                                    "row": 42,
                                    "column": 24
                                  },
                                  "text": "raise"
                                },
                                {
                                  "type": "argument_list",
                                  "start": {
                                    "row": 42,
                                    "column": 24
                                  },
                                  "end": {
                                    "row": 42,
                                    "column": 159
                                  },
                                  "text": "(RequestTimeoutException.new(env), \"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\")",
                                  "children": [
                                    {
                                      "type": "(",
                                      "start": {
                                        "row": 42,
                                        "column": 24
                                      },
                                      "end": {
                                        "row": 42,
                                        "column": 25
                                      },
                                      "text": "("
                                    },
                                    {
                                      "type": "call",
                                      "start": {
                                        "row": 42,
                                        "column": 25
                                      },
                                      "end": {
                                        "row": 42,
                                        "column": 57
                                      },
                                      "text": "RequestTimeoutException.new(env)",
                                      "children": [
                                        {
                                          "type": "constant",
                                          "start": {
                                            "row": 42,
                                            "column": 25
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 48
                                          },
                                          "text": "RequestTimeoutException"
                                        },
                                        {
                                          "type": ".",
                                          "start": {
                                            "row": 42,
                                            "column": 48
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 49
                                          },
                                          "text": "."
                                        },
                                        {
                                          "type": "identifier",
                                          "start": {
                                            "row": 42,
                                            "column": 49
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 52
                                          },
                                          "text": "new"
                                        },
                                        {
                                          "type": "argument_list",
                                          "start": {
                                            "row": 42,
                                            "column": 52
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 57
                                          },
                                          "text": "(env)",
                                          "children": [
                                            {
                                              "type": "(",
                                              "start": {
                                                "row": 42,
                                                "column": 52
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 53
                                              },
                                              "text": "("
                                            },
                                            {
                                              "type": "identifier",
                                              "start": {
                                                "row": 42,
                                                "column": 53
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 56
                                              },
                                              "text": "env"
                                            },
                                            {
                                              "type": ")",
                                              "start": {
                                                "row": 42,
                                                "column": 56
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 57
                                              },
                                              "text": ")"
                                            }
                                          ]
                                        }
                                      ]
                                    },
                                    {
                                      "type": ",",
                                      "start": {
                                        "row": 42,
                                        "column": 57
                                      },
                                      "end": {
                                        "row": 42,
                                        "column": 58
                                      },
                                      "text": ","
                                    },
                                    {
                                      "type": "string",
                                      "start": {
                                        "row": 42,
                                        "column": 59
                                      },
                                      "end": {
                                        "row": 42,
                                        "column": 158
                                      },
                                      "text": "\"Request #{\"waited #{info.ms(:wait)}, then \" if info.wait}ran for longer than #{info.ms(:timeout)}\"",
                                      "children": [
                                        {
                                          "type": "\"",
                                          "start": {
                                            "row": 42,
                                            "column": 59
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 60
                                          },
                                          "text": "\""
                                        },
                                        {
                                          "type": "string_content",
                                          "start": {
                                            "row": 42,
                                            "column": 60
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 68
                                          },
                                          "text": "Request "
                                        },
                                        {
                                          "type": "interpolation",
                                          "start": {
                                            "row": 42,
                                            "column": 68
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 117
                                          },
                                          "text": "#{\"waited #{info.ms(:wait)}, then \" if info.wait}",
                                          "children": [
                                            {
                                              "type": "#{",
                                              "start": {
                                                "row": 42,
                                                "column": 68
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 70
                                              },
                                              "text": "#{"
                                            },
                                            {
                                              "type": "if_modifier",
                                              "start": {
                                                "row": 42,
                                                "column": 70
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 116
                                              },
                                              "text": "\"waited #{info.ms(:wait)}, then \" if info.wait",
                                              "children": [
                                                {
                                                  "type": "string",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 70
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 103
                                                  },
                                                  "text": "\"waited #{info.ms(:wait)}, then \"",
                                                  "children": [
                                                    {
                                                      "type": "\"",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 70
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 71
                                                      },
                                                      "text": "\""
                                                    },
                                                    {
                                                      "type": "string_content",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 71
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 78
                                                      },
                                                      "text": "waited "
                                                    },
                                                    {
                                                      "type": "interpolation",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 78
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 95
                                                      },
                                                      "text": "#{info.ms(:wait)}",
                                                      "children": [
                                                        {
                                                          "type": "#{",
                                                          "start": {
                                                            "row": 42,
                                                            "column": 78
                                                          },
                                                          "end": {
                                                            "row": 42,
                                                            "column": 80
                                                          },
                                                          "text": "#{"
                                                        },
                                                        {
                                                          "type": "call",
                                                          "start": {
                                                            "row": 42,
                                                            "column": 80
                                                          },
                                                          "end": {
                                                            "row": 42,
                                                            "column": 94
                                                          },
                                                          "text": "info.ms(:wait)",
                                                          "children": [
                                                            {
                                                              "type": "identifier",
                                                              "start": {
                                                                "row": 42,
                                                                "column": 80
                                                              },
                                                              "end": {
                                                                "row": 42,
                                                                "column": 84
                                                              },
                                                              "text": "info"
                                                            },
                                                            {
                                                              "type": ".",
                                                              "start": {
                                                                "row": 42,
                                                                "column": 84
                                                              },
                                                              "end": {
                                                                "row": 42,
                                                                "column": 85
                                                              },
                                                              "text": "."
                                                            },
                                                            {
                                                              "type": "identifier",
                                                              "start": {
                                                                "row": 42,
                                                                "column": 85
                                                              },
                                                              "end": {
                                                                "row": 42,
                                                                "column": 87
                                                              },
                                                              "text": "ms"
                                                            },
                                                            {
                                                              "type": "argument_list",
                                                              "start": {
                                                                "row": 42,
                                                                "column": 87
                                                              },
                                                              "end": {
                                                                "row": 42,
                                                                "column": 94
                                                              },
                                                              "text": "(:wait)",
                                                              "children": [
                                                                {
                                                                  "type": "(",
                                                                  "start": {
                                                                    "row": 42,
                                                                    "column": 87
                                                                  },
                                                                  "end": {
                                                                    "row": 42,
                                                                    "column": 88
                                                                  },
                                                                  "text": "("
                                                                },
                                                                {
                                                                  "type": "simple_symbol",
                                                                  "start": {
                                                                    "row": 42,
                                                                    "column": 88
                                                                  },
                                                                  "end": {
                                                                    "row": 42,
                                                                    "column": 93
                                                                  },
                                                                  "text": ":wait"
                                                                },
                                                                {
                                                                  "type": ")",
                                                                  "start": {
                                                                    "row": 42,
                                                                    "column": 93
                                                                  },
                                                                  "end": {
                                                                    "row": 42,
                                                                    "column": 94
                                                                  },
                                                                  "text": ")"
                                                                }
                                                              ]
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "type": "}",
                                                          "start": {
                                                            "row": 42,
                                                            "column": 94
                                                          },
                                                          "end": {
                                                            "row": 42,
                                                            "column": 95
                                                          },
                                                          "text": "}"
                                                        }
                                                      ]
                                                    },
                                                    {
                                                      "type": "string_content",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 95
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 102
                                                      },
                                                      "text": ", then "
                                                    },
                                                    {
                                                      "type": "\"",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 102
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 103
                                                      },
                                                      "text": "\""
                                                    }
                                                  ]
                                                },
                                                {
                                                  "type": "if",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 104
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 106
                                                  },
                                                  "text": "if"
                                                },
                                                {
                                                  "type": "call",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 107
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 116
                                                  },
                                                  "text": "info.wait",
                                                  "children": [
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 107
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 111
                                                      },
                                                      "text": "info"
                                                    },
                                                    {
                                                      "type": ".",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 111
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 112
                                                      },
                                                      "text": "."
                                                    },
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 112
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 116
                                                      },
                                                      "text": "wait"
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "type": "}",
                                              "start": {
                                                "row": 42,
                                                "column": 116
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 117
                                              },
                                              "text": "}"
                                            }
                                          ]
                                        },
                                        {
                                          "type": "string_content",
                                          "start": {
                                            "row": 42,
                                            "column": 117
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 137
                                          },
                                          "text": "ran for longer than "
                                        },
                                        {
                                          "type": "interpolation",
                                          "start": {
                                            "row": 42,
                                            "column": 137
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 157
                                          },
                                          "text": "#{info.ms(:timeout)}",
                                          "children": [
                                            {
                                              "type": "#{",
                                              "start": {
                                                "row": 42,
                                                "column": 137
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 139
                                              },
                                              "text": "#{"
                                            },
                                            {
                                              "type": "call",
                                              "start": {
                                                "row": 42,
                                                "column": 139
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 156
                                              },
                                              "text": "info.ms(:timeout)",
                                              "children": [
                                                {
                                                  "type": "identifier",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 139
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 143
                                                  },
                                                  "text": "info"
                                                },
                                                {
                                                  "type": ".",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 143
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 144
                                                  },
                                                  "text": "."
                                                },
                                                {
                                                  "type": "identifier",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 144
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 146
                                                  },
                                                  "text": "ms"
                                                },
                                                {
                                                  "type": "argument_list",
                                                  "start": {
                                                    "row": 42,
                                                    "column": 146
                                                  },
                                                  "end": {
                                                    "row": 42,
                                                    "column": 156
                                                  },
                                                  "text": "(:timeout)",
                                                  "children": [
                                                    {
                                                      "type": "(",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 146
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 147
                                                      },
                                                      "text": "("
                                                    },
                                                    {
                                                      "type": "simple_symbol",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 147
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 155
                                                      },
                                                      "text": ":timeout"
                                                    },
                                                    {
                                                      "type": ")",
                                                      "start": {
                                                        "row": 42,
                                                        "column": 155
                                                      },
                                                      "end": {
                                                        "row": 42,
                                                        "column": 156
                                                      },
                                                      "text": ")"
                                                    }
                                                  ]
                                                }
                                              ]
                                            },
                                            {
                                              "type": "}",
                                              "start": {
                                                "row": 42,
                                                "column": 156
                                              },
                                              "end": {
                                                "row": 42,
                                                "column": 157
                                              },
                                              "text": "}"
                                            }
                                          ]
                                        },
                                        {
                                          "type": "\"",
                                          "start": {
                                            "row": 42,
                                            "column": 157
                                          },
                                          "end": {
                                            "row": 42,
                                            "column": 158
                                          },
                                          "text": "\""
                                        }
                                      ]
                                    },
                                    {
                                      "type": ")",
                                      "start": {
                                        "row": 42,
                                        "column": 158
                                      },
                                      "end": {
                                        "row": 42,
                                        "column": 159
                                      },
                                      "text": ")"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "end",
                          "start": {
                            "row": 43,
                            "column": 6
                          },
                          "end": {
                            "row": 43,
                            "column": 9
                          },
                          "text": "end"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "assignment",
              "start": {
                "row": 45,
                "column": 6
              },
              "end": {
                "row": 52,
                "column": 9
              },
              "text": "response = timeout.timeout(info.timeout) do           # perform request with timeout\n        begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end\n      end",
              "children": [
                {
                  "type": "identifier",
                  "start": {
                    "row": 45,
                    "column": 6
                  },
                  "end": {
                    "row": 45,
                    "column": 14
                  },
                  "text": "response"
                },
                {
                  "type": "=",
                  "start": {
                    "row": 45,
                    "column": 15
                  },
                  "end": {
                    "row": 45,
                    "column": 16
                  },
                  "text": "="
                },
                {
                  "type": "call",
                  "start": {
                    "row": 45,
                    "column": 17
                  },
                  "end": {
                    "row": 52,
                    "column": 9
                  },
                  "text": "timeout.timeout(info.timeout) do           # perform request with timeout\n        begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end\n      end",
                  "children": [
                    {
                      "type": "identifier",
                      "start": {
                        "row": 45,
                        "column": 17
                      },
                      "end": {
                        "row": 45,
                        "column": 24
                      },
                      "text": "timeout"
                    },
                    {
                      "type": ".",
                      "start": {
                        "row": 45,
                        "column": 24
                      },
                      "end": {
                        "row": 45,
                        "column": 25
                      },
                      "text": "."
                    },
                    {
                      "type": "identifier",
                      "start": {
                        "row": 45,
                        "column": 25
                      },
                      "end": {
                        "row": 45,
                        "column": 32
                      },
                      "text": "timeout"
                    },
                    {
                      "type": "argument_list",
                      "start": {
                        "row": 45,
                        "column": 32
                      },
                      "end": {
                        "row": 45,
                        "column": 46
                      },
                      "text": "(info.timeout)",
                      "children": [
                        {
                          "type": "(",
                          "start": {
                            "row": 45,
                            "column": 32
                          },
                          "end": {
                            "row": 45,
                            "column": 33
                          },
                          "text": "("
                        },
                        {
                          "type": "call",
                          "start": {
                            "row": 45,
                            "column": 33
                          },
                          "end": {
                            "row": 45,
                            "column": 45
                          },
                          "text": "info.timeout",
                          "children": [
                            {
                              "type": "identifier",
                              "start": {
                                "row": 45,
                                "column": 33
                              },
                              "end": {
                                "row": 45,
                                "column": 37
                              },
                              "text": "info"
                            },
                            {
                              "type": ".",
                              "start": {
                                "row": 45,
                                "column": 37
                              },
                              "end": {
                                "row": 45,
                                "column": 38
                              },
                              "text": "."
                            },
                            {
                              "type": "identifier",
                              "start": {
                                "row": 45,
                                "column": 38
                              },
                              "end": {
                                "row": 45,
                                "column": 45
                              },
                              "text": "timeout"
                            }
                          ]
                        },
                        {
                          "type": ")",
                          "start": {
                            "row": 45,
                            "column": 45
                          },
                          "end": {
                            "row": 45,
                            "column": 46
                          },
                          "text": ")"
                        }
                      ]
                    },
                    {
                      "type": "do_block",
                      "start": {
                        "row": 45,
                        "column": 47
                      },
                      "end": {
                        "row": 52,
                        "column": 9
                      },
                      "text": "do           # perform request with timeout\n        begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end\n      end",
                      "children": [
                        {
                          "type": "do",
                          "start": {
                            "row": 45,
                            "column": 47
                          },
                          "end": {
                            "row": 45,
                            "column": 49
                          },
                          "text": "do"
                        },
                        {
                          "type": "comment",
                          "start": {
                            "row": 45,
                            "column": 60
                          },
                          "end": {
                            "row": 45,
                            "column": 90
                          },
                          "text": "# perform request with timeout"
                        },
                        {
                          "type": "body_statement",
                          "start": {
                            "row": 46,
                            "column": 8
                          },
                          "end": {
                            "row": 51,
                            "column": 11
                          },
                          "text": "begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end",
                          "children": [
                            {
                              "type": "begin",
                              "start": {
                                "row": 46,
                                "column": 8
                              },
                              "end": {
                                "row": 51,
                                "column": 11
                              },
                              "text": "begin  @app.call(env)                               # boom, send request down the middleware chain\n        rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError\n        ensure\n          register_state_change.call :completed\n        end",
                              "children": [
                                {
                                  "type": "begin",
                                  "start": {
                                    "row": 46,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 46,
                                    "column": 13
                                  },
                                  "text": "begin"
                                },
                                {
                                  "type": "call",
                                  "start": {
                                    "row": 46,
                                    "column": 15
                                  },
                                  "end": {
                                    "row": 46,
                                    "column": 29
                                  },
                                  "text": "@app.call(env)",
                                  "children": [
                                    {
                                      "type": "instance_variable",
                                      "start": {
                                        "row": 46,
                                        "column": 15
                                      },
                                      "end": {
                                        "row": 46,
                                        "column": 19
                                      },
                                      "text": "@app"
                                    },
                                    {
                                      "type": ".",
                                      "start": {
                                        "row": 46,
                                        "column": 19
                                      },
                                      "end": {
                                        "row": 46,
                                        "column": 20
                                      },
                                      "text": "."
                                    },
                                    {
                                      "type": "identifier",
                                      "start": {
                                        "row": 46,
                                        "column": 20
                                      },
                                      "end": {
                                        "row": 46,
                                        "column": 24
                                      },
                                      "text": "call"
                                    },
                                    {
                                      "type": "argument_list",
                                      "start": {
                                        "row": 46,
                                        "column": 24
                                      },
                                      "end": {
                                        "row": 46,
                                        "column": 29
                                      },
                                      "text": "(env)",
                                      "children": [
                                        {
                                          "type": "(",
                                          "start": {
                                            "row": 46,
                                            "column": 24
                                          },
                                          "end": {
                                            "row": 46,
                                            "column": 25
                                          },
                                          "text": "("
                                        },
                                        {
                                          "type": "identifier",
                                          "start": {
                                            "row": 46,
                                            "column": 25
                                          },
                                          "end": {
                                            "row": 46,
                                            "column": 28
                                          },
                                          "text": "env"
                                        },
                                        {
                                          "type": ")",
                                          "start": {
                                            "row": 46,
                                            "column": 28
                                          },
                                          "end": {
                                            "row": 46,
                                            "column": 29
                                          },
                                          "text": ")"
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "type": "comment",
                                  "start": {
                                    "row": 46,
                                    "column": 60
                                  },
                                  "end": {
                                    "row": 46,
                                    "column": 106
                                  },
                                  "text": "# boom, send request down the middleware chain"
                                },
                                {
                                  "type": "rescue",
                                  "start": {
                                    "row": 47,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 48,
                                    "column": 157
                                  },
                                  "text": "rescue RequestTimeoutException => e                 # will actually hardly ever get to this point because frameworks tend to catch this. see README for more\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError",
                                  "children": [
                                    {
                                      "type": "rescue",
                                      "start": {
                                        "row": 47,
                                        "column": 8
                                      },
                                      "end": {
                                        "row": 47,
                                        "column": 14
                                      },
                                      "text": "rescue"
                                    },
                                    {
                                      "type": "exceptions",
                                      "start": {
                                        "row": 47,
                                        "column": 15
                                      },
                                      "end": {
                                        "row": 47,
                                        "column": 38
                                      },
                                      "text": "RequestTimeoutException",
                                      "children": [
                                        {
                                          "type": "constant",
                                          "start": {
                                            "row": 47,
                                            "column": 15
                                          },
                                          "end": {
                                            "row": 47,
                                            "column": 38
                                          },
                                          "text": "RequestTimeoutException"
                                        }
                                      ]
                                    },
                                    {
                                      "type": "exception_variable",
                                      "start": {
                                        "row": 47,
                                        "column": 39
                                      },
                                      "end": {
                                        "row": 47,
                                        "column": 43
                                      },
                                      "text": "=> e",
                                      "children": [
                                        {
                                          "type": "=>",
                                          "start": {
                                            "row": 47,
                                            "column": 39
                                          },
                                          "end": {
                                            "row": 47,
                                            "column": 41
                                          },
                                          "text": "=>"
                                        },
                                        {
                                          "type": "identifier",
                                          "start": {
                                            "row": 47,
                                            "column": 42
                                          },
                                          "end": {
                                            "row": 47,
                                            "column": 43
                                          },
                                          "text": "e"
                                        }
                                      ]
                                    },
                                    {
                                      "type": "comment",
                                      "start": {
                                        "row": 47,
                                        "column": 60
                                      },
                                      "end": {
                                        "row": 47,
                                        "column": 164
                                      },
                                      "text": "# will actually hardly ever get to this point because frameworks tend to catch this. see README for more"
                                    },
                                    {
                                      "type": "then",
                                      "start": {
                                        "row": 47,
                                        "column": 164
                                      },
                                      "end": {
                                        "row": 48,
                                        "column": 157
                                      },
                                      "text": "\n          raise RequestTimeoutError.new(env), e.message, e.backtrace  # but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError",
                                      "children": [
                                        {
                                          "type": "call",
                                          "start": {
                                            "row": 48,
                                            "column": 10
                                          },
                                          "end": {
                                            "row": 48,
                                            "column": 68
                                          },
                                          "text": "raise RequestTimeoutError.new(env), e.message, e.backtrace",
                                          "children": [
                                            {
                                              "type": "identifier",
                                              "start": {
                                                "row": 48,
                                                "column": 10
                                              },
                                              "end": {
                                                "row": 48,
                                                "column": 15
                                              },
                                              "text": "raise"
                                            },
                                            {
                                              "type": "argument_list",
                                              "start": {
                                                "row": 48,
                                                "column": 16
                                              },
                                              "end": {
                                                "row": 48,
                                                "column": 68
                                              },
                                              "text": "RequestTimeoutError.new(env), e.message, e.backtrace",
                                              "children": [
                                                {
                                                  "type": "call",
                                                  "start": {
                                                    "row": 48,
                                                    "column": 16
                                                  },
                                                  "end": {
                                                    "row": 48,
                                                    "column": 44
                                                  },
                                                  "text": "RequestTimeoutError.new(env)",
                                                  "children": [
                                                    {
                                                      "type": "constant",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 16
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 35
                                                      },
                                                      "text": "RequestTimeoutError"
                                                    },
                                                    {
                                                      "type": ".",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 35
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 36
                                                      },
                                                      "text": "."
                                                    },
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 36
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 39
                                                      },
                                                      "text": "new"
                                                    },
                                                    {
                                                      "type": "argument_list",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 39
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 44
                                                      },
                                                      "text": "(env)",
                                                      "children": [
                                                        {
                                                          "type": "(",
                                                          "start": {
                                                            "row": 48,
                                                            "column": 39
                                                          },
                                                          "end": {
                                                            "row": 48,
                                                            "column": 40
                                                          },
                                                          "text": "("
                                                        },
                                                        {
                                                          "type": "identifier",
                                                          "start": {
                                                            "row": 48,
                                                            "column": 40
                                                          },
                                                          "end": {
                                                            "row": 48,
                                                            "column": 43
                                                          },
                                                          "text": "env"
                                                        },
                                                        {
                                                          "type": ")",
                                                          "start": {
                                                            "row": 48,
                                                            "column": 43
                                                          },
                                                          "end": {
                                                            "row": 48,
                                                            "column": 44
                                                          },
                                                          "text": ")"
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                },
                                                {
                                                  "type": ",",
                                                  "start": {
                                                    "row": 48,
                                                    "column": 44
                                                  },
                                                  "end": {
                                                    "row": 48,
                                                    "column": 45
                                                  },
                                                  "text": ","
                                                },
                                                {
                                                  "type": "call",
                                                  "start": {
                                                    "row": 48,
                                                    "column": 46
                                                  },
                                                  "end": {
                                                    "row": 48,
                                                    "column": 55
                                                  },
                                                  "text": "e.message",
                                                  "children": [
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 46
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 47
                                                      },
                                                      "text": "e"
                                                    },
                                                    {
                                                      "type": ".",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 47
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 48
                                                      },
                                                      "text": "."
                                                    },
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 48
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 55
                                                      },
                                                      "text": "message"
                                                    }
                                                  ]
                                                },
                                                {
                                                  "type": ",",
                                                  "start": {
                                                    "row": 48,
                                                    "column": 55
                                                  },
                                                  "end": {
                                                    "row": 48,
                                                    "column": 56
                                                  },
                                                  "text": ","
                                                },
                                                {
                                                  "type": "call",
                                                  "start": {
                                                    "row": 48,
                                                    "column": 57
                                                  },
                                                  "end": {
                                                    "row": 48,
                                                    "column": 68
                                                  },
                                                  "text": "e.backtrace",
                                                  "children": [
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 57
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 58
                                                      },
                                                      "text": "e"
                                                    },
                                                    {
                                                      "type": ".",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 58
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 59
                                                      },
                                                      "text": "."
                                                    },
                                                    {
                                                      "type": "identifier",
                                                      "start": {
                                                        "row": 48,
                                                        "column": 59
                                                      },
                                                      "end": {
                                                        "row": 48,
                                                        "column": 68
                                                      },
                                                      "text": "backtrace"
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        },
                                        {
                                          "type": "comment",
                                          "start": {
                                            "row": 48,
                                            "column": 70
                                          },
                                          "end": {
                                            "row": 48,
                                            "column": 157
                                          },
                                          "text": "# but in case it does get here, re-raise RequestTimeoutException as RequestTimeoutError"
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "type": "ensure",
                                  "start": {
                                    "row": 49,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 50,
                                    "column": 47
                                  },
                                  "text": "ensure\n          register_state_change.call :completed",
                                  "children": [
                                    {
                                      "type": "ensure",
                                      "start": {
                                        "row": 49,
                                        "column": 8
                                      },
                                      "end": {
                                        "row": 49,
                                        "column": 14
                                      },
                                      "text": "ensure"
                                    },
                                    {
                                      "type": "call",
                                      "start": {
                                        "row": 50,
                                        "column": 10
                                      },
                                      "end": {
                                        "row": 50,
                                        "column": 47
                                      },
                                      "text": "register_state_change.call :completed",
                                      "children": [
                                        {
                                          "type": "identifier",
                                          "start": {
                                            "row": 50,
                                            "column": 10
                                          },
                                          "end": {
                                            "row": 50,
                                            "column": 31
                                          },
                                          "text": "register_state_change"
                                        },
                                        {
                                          "type": ".",
                                          "start": {
                                            "row": 50,
                                            "column": 31
                                          },
                                          "end": {
                                            "row": 50,
                                            "column": 32
                                          },
                                          "text": "."
                                        },
                                        {
                                          "type": "identifier",
                                          "start": {
                                            "row": 50,
                                            "column": 32
                                          },
                                          "end": {
                                            "row": 50,
                                            "column": 36
                                          },
                                          "text": "call"
                                        },
                                        {
                                          "type": "argument_list",
                                          "start": {
                                            "row": 50,
                                            "column": 37
                                          },
                                          "end": {
                                            "row": 50,
                                            "column": 47
                                          },
                                          "text": ":completed",
                                          "children": [
                                            {
                                              "type": "simple_symbol",
                                              "start": {
                                                "row": 50,
                                                "column": 37
                                              },
                                              "end": {
                                                "row": 50,
                                                "column": 47
                                              },
                                              "text": ":completed"
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "type": "end",
                                  "start": {
                                    "row": 51,
                                    "column": 8
                                  },
                                  "end": {
                                    "row": 51,
                                    "column": 11
                                  },
                                  "text": "end"
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "type": "end",
                          "start": {
                            "row": 52,
                            "column": 6
                          },
                          "end": {
                            "row": 52,
                            "column": 9
                          },
                          "text": "end"
                        }
                      ]
                    }
                  ]
                }
              ]
            },
            {
              "type": "identifier",
              "start": {
                "row": 54,
                "column": 6
              },
              "end": {
                "row": 54,
                "column": 14
              },
              "text": "response"
            }
          ]
        },
        {
          "type": "end",
          "start": {
            "row": 55,
            "column": 4
          },
          "end": {
            "row": 55,
            "column": 7
          },
          "text": "end"
        }
      ]
    }
  ]
}